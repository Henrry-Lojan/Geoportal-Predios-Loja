<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoLoja - Portal Catastral</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Fuentes Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@700;800&display=swap"
        rel="stylesheet">
    <!-- Proj4js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <!-- Turf.js for Geometry Operations -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>


    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --text-light: #f8fafc;
            --text-gray: #94a3b8;
            --sidebar-width: 350px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
            background: var(--bg-dark);
            color: var(--text-light);
        }

        /* --- SIDEBAR IZQUIERDA --- */
        #sidebar {
            width: var(--sidebar-width);
            background: var(--bg-panel);
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.4);
            z-index: 1000;
        }

        .sidebar-header {
            padding: 15px 20px;
            display: flex;
            justify-content: center;
            /* Centrado General */
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            background: inherit;
            /* Ensure background allows layering */
        }

        #sidebar.minimized {
            transform: translateY(calc(100% - 80px));
        }

        .logo-title {
            font-family: 'Outfit', sans-serif;
            font-size: 22px;
            /* Reducido a 22px */
            font-weight: 800;
            color: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Centrado */
            gap: 6px;
            letter-spacing: -0.5px;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            width: 100%;
        }

        .logo-title span {
            background: linear-gradient(135deg, #3b82f6 0%, #22d3ee 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 22px;
            /* Ajustado */
            filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.3));
        }

        .logo-subtitle {
            font-size: 13px;
            color: var(--text-gray);
            margin-top: 5px;
            font-weight: 400;
        }

        .search-container {
            padding: 25px;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            background: #0f172a;
            border: 1px solid #334155;
            color: white;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .btn-search {
            width: 100%;
            padding: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-search:hover {
            background: var(--primary-dark);
        }

        .btn-clear {
            background: transparent;
            border: 1px solid #334155;
            color: var(--text-gray);
            border-radius: 8px;
            cursor: pointer;
        }

        .btn-clear:hover {
            background: #334155;
            color: white;
            border-color: #ef4444;
        }

        /* --- PANEL DE RESULTADOS --- */
        .results-panel {
            flex: 1;
            overflow-y: auto;
            padding: 0 25px 25px 25px;
        }



        /* Estilos Calculadora */
        .calc-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .calc-header {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .calc-total {
            font-weight: 800;
            border-top: 1px solid #cbd5e1;
            padding-top: 8px;
            color: #0f172a;
            margin-top: 5px;
        }

        /* Tabla Comparativa */
        .market-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .market-table th {
            text-align: left;
            padding: 8px;
            background: #f1f5f9;
            color: #475569;
        }

        .market-table td {
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
        }

        .market-highlight {
            background: #ecfdf5;
            font-weight: 700;
            color: #059669;
        }

        .empty-state {
            text-align: center;
            color: var(--text-gray);
            margin-top: 50px;
            font-size: 14px;
        }

        .info-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 6px;
        }

        .info-card h3 {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--primary);
            margin-bottom: 6px;
            letter-spacing: 0.5px;
            font-weight: 700;
            border-bottom: 1px solid #334155;
            padding-bottom: 4px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
            font-size: 11px;
        }

        .data-label {
            color: var(--text-gray);
        }

        .data-value {
            font-weight: 600;
            text-align: right;
            max-width: 60%;
        }

        .btn-report {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 8px 12px;
            /* Reducido de 15px */
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            /* Reducido para compactar */
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }



        .btn-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .status-bar {
            padding: 10px 20px;
            background: #0f172a;
            font-size: 12px;
            color: var(--text-gray);
            border-top: 1px solid #334155;
            display: flex;
            justify-content: space-between;
        }

        /* --- MAPA --- */
        #map {
            flex: 1;
            width: 100%;
            background: #0f172a;
        }

        .leaflet-container {
            background: #0f172a;
        }

        /* --- MODAL REPORTE (L√≠nea de F√°brica) --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .report-paper {
            background: white;
            color: #333;
            width: 100%;
            max-width: 900px;
            height: 90vh;
            overflow-y: auto;
            padding: 40px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        /* Estilos de Impresi√≥n */
        @media print {
            body * {
                visibility: hidden;
            }

            .modal {
                position: absolute;
                left: 0;
                top: 0;
                background: white;
                padding: 0;
            }

            .report-paper,
            .report-paper * {
                visibility: visible;
            }

            .report-paper {
                box-shadow: none;
                height: auto;
                padding: 0;
                overflow: visible;
            }

            .no-print {
                display: none !important;
            }
        }

        .report-header {
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .report-title {
            font-size: 22px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .report-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .technical-box {
            border: 1px solid #333;
        }

        .box-title {
            background: #eee;
            padding: 5px 10px;
            font-weight: 700;
            border-bottom: 1px solid #333;
            font-size: 12px;
            text-transform: uppercase;
        }

        .box-content {
            padding: 10px;
            font-size: 11px;
        }

        .report-row {
            display: flex;
            border-bottom: 1px solid #ddd;
            padding: 4px 0;
        }

        .report-row:last-child {
            border-bottom: none;
        }

        .report-label {
            font-weight: 700;
            width: 40%;
        }

        .report-val {
            width: 60%;
        }

        #miniMap {
            height: 300px;
            width: 100%;
            border: 1px solid #333;
            margin-bottom: 20px;
        }

        .badge-ok {
            color: green;
            font-weight: bold;
        }

        .badge-alert {
            color: #d97706;
            font-weight: bold;
        }

        /* Estilos personalizados para Popups */
        .leaflet-popup-content-wrapper {
            background: #1e293b;
            color: #f8fafc;
            border-radius: 8px;
        }

        .leaflet-popup-tip {
            background: #1e293b;
        }

        .leaflet-popup-content b {
            color: #6366f1;
            font-size: 14px;
        }

        /* Etiquetas para Parroquias */
        .parroquia-label {
            background: transparent;
            border: none;
            box-shadow: none;
            font-size: 12px;
            font-weight: 900;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 2px 2px 0px rgba(255, 255, 255, 0.8);
        }

        /* Etiquetas para Barrios (Din√°micas) */
        /* Etiquetas para Barrios (Din√°micas) */
        /* Etiquetas para Barrios (Din√°micas) */
        .barrio-label {
            background: transparent;
            /* SIN RELLENO */
            border: none;
            box-shadow: none;
            color: #fff;
            font-weight: 700;
            /* Negrita para que se lea mejor sin fondo */
            text-transform: uppercase;
            /* Borde negro fuerte (stroke) para lectura perfecta */
            text-shadow:
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000,
                2px 2px 3px rgba(0, 0, 0, 0.5);
            text-align: center;
            white-space: normal;
            line-height: 1.1;
            padding: 0;

            /* Control din√°mico Un poco m√°s grande */
            font-size: var(--barrio-label-size, 10px);
            opacity: var(--barrio-label-opacity, 1);
            transition: all 0.2s ease-out;
            pointer-events: none;
        }

        /* Modal Selecci√≥n de Rol */
        #roleModal {
            display: none;
            /* Se activa con JS */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        #roleModal.active {
            display: flex;
        }

        .role-container {
            background: #1e293b;
            padding: 40px;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            text-align: center;
            border: 1px solid #334155;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .role-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .role-card {
            background: #0f172a;
            border: 1px solid #334155;
            padding: 25px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .role-card:hover {
            border-color: var(--primary);
            background: #1e1b4b;
            /* Indigo muy oscuro */
            transform: translateY(-5px);
        }

        .role-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .role-name {
            font-weight: 600;
            color: #f8fafc;
        }

        /* --- ACTION GRID (Botones Cuadrados) --- */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .action-btn {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 10px 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
            height: 70px;
            /* Altura fija uniforme */
        }

        .action-btn:hover {
            background: #334155;
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .action-btn.active {
            background: #be123c;
            /* Estado Activo (Rojo/Cancel) */
            border-color: #f43f5e;
        }

        .action-icon {
            font-size: 20px;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.3));
        }

        .action-label {
            font-size: 9px;
            color: #cbd5e1;
            text-align: center;
            line-height: 1.2;
            font-weight: 500;
        }
    </style>
    <!-- Estilos Responsivos (Mobile) -->
    <style>
        /* CORRECCI√ìN DE POSICI√ìN DEL PANEL DERECHO */
        #rightPanel {
            position: absolute;
            bottom: 30px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }


            /* El mapa ocupa toda la pantalla de fondo */
            #map {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1;
            }

            /* La barra lateral se convierte en un panel inferior flotante */
            #sidebar {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: auto;
                max-height: 60vh;
                /* M√°ximo 60% de la pantalla */
                background: rgba(30, 41, 59, 0.95);
                backdrop-filter: blur(10px);
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 20px 20px 0 0;
                z-index: 1000;
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                /* Permite hacer scroll si el contenido es muy largo */
                display: flex;
                flex-direction: column;
            }

            #sidebar.minimized {
                transform: translateY(calc(100% - 70px));
            }

            .sidebar-header {
                padding: 15px 25px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                /* Indicar que es tocable */
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

            .logo-title {
                font-size: 18px;
            }

            .logo-subtitle {
                display: none;
                /* Ahorrar espacio en m√≥vil */
            }

            .mobile-toggle {
                display: block !important;
                transition: transform 0.3s;
            }

            /* Indicador de "Deslizar" */
            .sidebar-header::after {
                content: '';
                width: 40px;
                height: 4px;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 2px;
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
            }

            .search-container {
                padding: 15px 25px;
            }

            .results-panel {
                padding: 0 25px 25px 25px;
                overflow-y: auto;
            }

            /* Modales ocupan m√°s espacio */
            .report-paper {
                height: 100%;
                max-height: 100%;
                width: 100%;
                border-radius: 0;
                padding: 20px;
            }

            .role-container {
                width: 95%;
                padding: 20px;
            }

            .role-grid {
                grid-template-columns: 1fr 1fr;
                /* 2 columnas en m√≥vil */
                gap: 10px;
            }

            /* Ajuste derecha m√≥vil: Estilo "Google Maps" con botones circulares */
            #rightPanel {
                display: flex !important;
                right: 15px;
                bottom: 15vh;
                /* Se ajusta din√°micamente */
                top: auto;
                width: auto;
                max-width: none;
                align-items: flex-end;
                /* Todo a la derecha */
                gap: 12px;
                pointer-events: none;
            }

            #rightPanel button {
                pointer-events: auto;
                width: 48px;
                height: 48px;
                border-radius: 50%;
                /* CIRCULARES */
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px !important;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
                background: #10b981;
                /* Color base */
                border: 2px solid rgba(255, 255, 255, 0.2);
            }

            /* Ocultar texto (segundo span), mostrar solo icono (primer span) */
            #rightPanel button span:nth-child(2) {
                display: none;
            }

            #rightPanel button span:first-child {
                display: block;
                /* Asegurar que el icono se vea */
                font-size: 24px;
                line-height: 1;
            }

            /* Ajuste Panel Inferior (Bottom Sheet) Premium */
            #sidebar {
                border-radius: 20px 20px 0 0;
                background: rgba(15, 23, 42, 0.98);
                /* Casi opaco */
                box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
            }

            #sidebar.minimized {
                transform: translateY(calc(100% - 80px));
                /* Mostrar un poco m√°s */
            }

            /* Barra de "Agarre" visual */
            .sidebar-header::before {
                content: '';
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 5px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 3px;
            }

            .sidebar-header::after {
                display: none;
            }

            /* Quitar anterior */

            .leaflet-control-layers-expanded {
                max-width: 250px;
                font-size: 12px;
            }
        }

        /* --- PANEL DERECHO DE ACCIONES (Escritorio y Defecto) --- */
        #rightPanel {
            position: absolute;
            bottom: 30px;
            right: 20px;
            width: 200px;
            /* Ancho fijo para alineaci√≥n */
            background: transparent;
            z-index: 1000;
            display: none;
            /* Se activa con JS al seleccionar predio */
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }



        #rightPanel button {
            pointer-events: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            opacity: 0;
            animation: slideInRight 0.3s forwards;
            margin: 0;
            /* Override default margins */
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
    <style>
        /* --- AJUSTES DE ESPACIO Y CONFLICTOS (User Request) --- */

        /* 1. Control de Capas: Reducido LIGERAMENTE sin scroll */
        .leaflet-control-layers-expanded {
            /* max-height: 45vh;  <-- ELIMINADO (Scroll) */
            /* overflow-y: auto;  <-- ELIMINADO (Scroll) */

            transform: scale(0.92);
            /* Ajustado al 92% (solicitado +7%) */
            transform-origin: top right;
            /* Anclado arriba a la derecha */

            font-size: 11px !important;
            padding: 5px 8px !important;
            opacity: 0.95;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .leaflet-control-layers label {
            margin-bottom: 3px !important;
        }

        /* 2. Panel de botones (Planimetr√≠a, etc) m√°s peque√±o */
        #rightPanel {
            right: 15px !important;
            bottom: 25px !important;
            width: 170px !important;
            /* M√°s angosto */
            gap: 6px !important;
            transform: scale(0.95);
            /* Reducir al 95% del tama√±o original */
            transform-origin: bottom right;
        }

        .btn-report {
            font-size: 12px !important;
            padding: 6px 10px !important;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div id="sidebar">
        <div class="sidebar-header" onclick="toggleSidebarMobile()">
            <div class="header-content" style="width: 100%; text-align: center;">
                <div class="logo-title">
                    <span>GEO</span>PORTAL LOJA
                </div>
                <div class="mobile-toggle" style="display:none; font-size:18px; color:#94a3b8;">üîΩ</div>
                <div class="logo-subtitle" style="text-align:center;">GESTI√ìN CATASTRAL INTELIGENTE</div>
            </div>
        </div>

        <div class="search-container">
            <div class="search-box">
                <input type="text" id="claveInput" placeholder="Clave Catastral (Ej: 110103...)"
                    value="1101030404320013">
            </div>
            <div style="display:flex; gap:5px;">
                <button class="btn-search" onclick="buscarPredio()" style="flex:1;">üîç Consultar</button>
                <button class="btn-clear" onclick="limpiarMapa()"
                    style="width:40px; display:flex; align-items:center; justify-content:center;"
                    title="Limpiar B√∫squeda">üóëÔ∏è</button>
            </div>

            <!-- Separador Visual Minimalista -->
            <div style="margin: 12px 0; border-top: 1px solid #1e293b;"></div>

            <!-- Buscador Coordenadas Minimalista -->
            <div class="search-box" style="display:flex; gap:5px; align-items: center; margin-bottom: 0;">
                <span style="font-size: 16px;">üìç</span>
                <input type="text" id="coordInput" placeholder="Pegar Link Maps o Coordenadas..."
                    style="font-size:12px; background:#0f172a; border-color:#334155; padding: 10px;">
                <button onclick="buscarPorCoordenadas()"
                    style="width:40px; background:#3b82f6; border:none; border-radius:8px; cursor:pointer;"
                    title="Ir a coordenadas">
                    üöÄ
                </button>
            </div>
        </div>

        <div class="results-panel" id="resultsPanel">
            <!-- Aqu√≠ se inyectar√° la info -->
            <div class="empty-state">
                <p>Ingresa una clave catastral para ver<br>la informaci√≥n t√©cnica, retiros y normativa.</p>
            </div>
        </div>



        <div class="status-bar">
            <span id="statusText">Listo</span>
            <span id="coordText"></span>
        </div>
    </div>
    </div>



    <!-- Modal Calculadora Edificable -->
    <div id="calcModal" class="modal">
        <div class="report-paper" style="background: #f8fafc; border-top: 10px solid #2563eb; max-width: 1000px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div>
                    <h2 style="color: #1e3a8a; font-size: 24px; font-weight: 800;">üèóÔ∏è Calculadora Edificable &
                        Inmobiliaria</h2>
                    <p style="color: #64748b; margin:0;">An√°lisis de potencial constructivo y financiero</p>
                </div>
                <button onclick="document.getElementById('calcModal').classList.remove('active')"
                    style="background:none; border:none; font-size:28px; cursor:pointer; color:#64748b;">&times;</button>
            </div>

            <div id="calcContent"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <!-- Mapa Principal -->
    <div id="map"></div>


    <!-- Panel Derecho de Acciones (Flotante) -->
    <div id="rightPanel"></div>





    <!-- Modal de Reporte -->
    <div class="modal" id="reportModal">
        <div class="report-paper">
            <div class="no-print" style="text-align: right; margin-bottom: 20px;">
                <button onclick="window.print()"
                    style="padding: 10px 20px; background: #333; color: white; border: none; cursor: pointer;">üñ®Ô∏è
                    Imprimir Reporte</button>
                <button onclick="cerrarReporte()"
                    style="padding: 10px 20px; background: #ef4444; color: white; border: none; cursor: pointer;">Cerrar</button>
            </div>

            <div class="report-header">
                <h2>MUNICIPIO DE LOJA</h2>
                <h3>DIRECCI√ìN DE PLANIFICACI√ìN Y CATASTROS</h3>
                <p>INFORME T√âCNICO DE REGULACI√ìN URBANA (L√çNEA DE F√ÅBRICA)</p>
            </div>

            <div id="reportContent">
                <!-- Se llena din√°micamente -->
            </div>

            <div style="margin-top: 40px; display: flex; justify-content: space-between; align-items: flex-end;">
                <div style="text-align: center; border-top: 1px solid #333; width: 200px; padding-top: 10px;">
                    Responsable T√©cnico<br>Direcci√≥n de Catastros
                </div>
                <div style="font-size: 10px;">
                    Generado el: <span id="reportDate"></span>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Modal Planimetr√≠a -->
    <div class="modal" id="planimetriaModal">
        <div class="report-paper">
            <div class="no-print" style="text-align: right; margin-bottom: 20px;">
                <button onclick="window.print()"
                    style="padding: 10px 20px; background: #333; color: white; border: none; cursor: pointer;">üñ®Ô∏è
                    Imprimir</button>
                <button onclick="cerrarPlanimetria()"
                    style="padding: 10px 20px; background: #ef4444; color: white; border: none; cursor: pointer;">Cerrar</button>
            </div>

            <div class="report-header">
                <h2>LEVANTAMIENTO PLANIM√âTRICO</h2>
                <h3>MUNICIPIO DE LOJA</h3>
            </div>

            <div id="planimetriaContent" style="display: flex; flex-direction: column; align-items: center;">

                <!-- SVG Canvas -->
                <div id="svgContainer"
                    style="width: 100%; height: 500px; border: 2px solid #000; margin-bottom: 20px; position:relative; background:white;">
                    <!-- SVG se inyecta aqu√≠ -->
                </div>

                <!-- Linderos Text Info (Debajo del mapa) -->
                <div id="linderosInfoBox" style="width:100%; margin-bottom:20px;"></div>

                <!-- Tabla de Coordenadas Container -->
                <div id="tableContainer" style="width: 100%;">
                    <!-- La tabla se generar√° aqu√≠ -->
                </div>
                <div style="margin-top: 20px; width:100%; text-align: left; font-size:12px;">
                    <strong>√ÅREA TOTAL:</strong> <span id="planoArea"></span> m¬≤
                </div>


            </div>
        </div>
    </div>

    <!-- Modal Reporte Ciudadano -->
    <div id="ciudadanoModal" class="modal">
        <div class="report-paper" style="background: #fdfbf7; border-top: 10px solid #8b5cf6;">
            <div style="text-align:right;">
                <button onclick="cerrarReporteCiudadano()"
                    style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b;">&times;</button>
            </div>

            <div style="text-align: center; margin-bottom: 30px;">
                <span style="font-size: 40px;">üè°</span>
                <h2 style="color: #4c1d95; font-size: 28px; font-weight: 800; margin-top: 10px;">Tu Lote Explicado F√°cil
                </h2>
                <p style="color: #6d28d9; font-size:16px;">Entiende tu propiedad sin tecnicismos.</p>
            </div>

            <div id="ciudadanoContent" style="display: grid; gap: 30px;">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- Modal Selecci√≥n Rol -->
    <div id="roleModal">
        <div class="role-container">
            <h1 style="color:white; margin-bottom:10px;">¬°Bienvenido a GeoLoja! üåç</h1>
            <p style="color:#94a3b8; font-size:16px;">Por favor, selecciona tu perfil para continuar:</p>

            <div class="role-grid">
                <div class="role-card" onclick="selectRole('Arquitecto')">
                    <div class="role-icon">üìê</div>
                    <div class="role-name">Arquitecto</div>
                </div>
                <div class="role-card" onclick="selectRole('Contratista/Constructora')">
                    <div class="role-icon">üöú</div>
                    <div class="role-name">Contratista / Constructora</div>
                </div>
                <div class="role-card" onclick="selectRole('Propietario/Ciudadano')">
                    <div class="role-icon">üè°</div>
                    <div class="role-name">Propietario / Ciudadano</div>
                </div>
                <div class="role-card" onclick="selectRole('Ingeniero Civil')">
                    <div class="role-icon">üèóÔ∏è</div>
                    <div class="role-name">Ingeniero Civil</div>
                </div>
                <div class="role-card" onclick="selectRole('Top√≥grafo')">
                    <div class="role-icon">üó∫Ô∏è</div>
                    <div class="role-name">Top√≥grafo</div>
                </div>
                <div class="role-card" onclick="selectRole('Inmobiliaria')">
                    <div class="role-icon">üè¢</div>
                    <div class="role-name">Inmobiliaria</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const { createClient } = supabase;
        const client = createClient(
            'https://fsdtrbbyzfxlnwlmgzwr.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzZHRyYmJ5emZ4bG53bG1nendyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MDk1NzIsImV4cCI6MjA4MjI4NTU3Mn0.hAQkrjZZwm2_1XXMirAvF5-BvJ8Wf0yAN2BJgy-OnBE'
        );

        let map, predioLayer, reportMap, vecinosLayer;
        let mapLocBarrio, mapLocParroquia; // Variables para los mini-mapas
        let layerControl;
        let overlayMaps = {};
        let currentData = null;

        // Variables para manejo din√°mico de barrios por parroquia
        let datosBarrios = [];
        let datosParroquias = []; // Store parroquias globally for clipping
        let activeBarrioLayers = {}; // Mapa para guardar referencias a capas de barrios activas { "NOMBRE_PARROQUIA": layer }
        let activeBarrioNames = new Set(); // Nombres de barrios visibles actualmente
        let prediosVistaLayer; // Capa de predios por vista
        let isPrediosLayerActive = false;

        // Inicializar Mapa
        function initMap() {
            // Definir proyecci√≥n EPSG:32717 globalmente
            if (typeof proj4 !== 'undefined' && !proj4.defs("EPSG:32717")) {
                proj4.defs("EPSG:32717", "+proj=utm +zone=17 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs");
            }

            map = L.map('map', { zoomControl: false }).setView([-4.005, -79.210], 16);

            const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            L.control.zoom({ position: 'topright' }).addTo(map);

            const baseMaps = {
                "OpenStreetMap": osm
            };

            const isMobile = window.innerWidth < 768;
            layerControl = L.control.layers(baseMaps, overlayMaps, {
                position: 'topright',
                collapsed: isMobile // Colapsado en m√≥vil, expandido en PC
            }).addTo(map);

            // --- EVENTOS P√ÅRA CARGA DIN√ÅMICA DE BARRIOS ---
            map.on('overlayadd', function (e) {
                // Verificamos si la capa activada es una capa de Parroquia Individual (prefijo üèòÔ∏è Barrios)
                if (e.name && e.name.startsWith('üèòÔ∏è Barrios ')) {
                    const nombreParroquia = e.name.replace('üèòÔ∏è Barrios ', '').trim();
                    mostrarBarriosDeParroquia(nombreParroquia);
                }
            });

            map.on('overlayremove', function (e) {
                if (e.name && e.name.startsWith('üèòÔ∏è Barrios ')) {
                    const nombreParroquia = e.name.replace('üèòÔ∏è Barrios ', '').trim();
                    ocultarBarriosDeParroquia(nombreParroquia);
                }
            });

            // Evento Zoom para ajustar etiquetas
            map.on('zoomend', updateLabelSize);
            updateLabelSize(); // Init

            // --- CONFIGURACI√ìN CAPA PREDIOS (VIEWPORT) ---

            prediosVistaLayer = L.featureGroup(); // Init SIN a√±adir al mapa
            isPrediosLayerActive = false; // Inactivo por defecto (no se carga nada)

            // NO agregamos al control aqu√≠ para que salga al √∫ltimo
            // layerControl.addOverlay se mueve a cargarCapas()

            // Carga inicial evitada (se carga solo al activar)
            // cargarPrediosVista();

            // Event listeners para la capa se manejan manualmente en el toggle
            map.on('moveend', function () {
                if (isPrediosLayerActive) {
                    cargarPrediosVista();
                }
            });

            // Crear Pane para Mapas de Calor (z-index 450 para que est√© por encima de otras capas base, pero bajo popups)
            map.createPane('heatmapPane');
            map.getPane('heatmapPane').style.zIndex = 450;
            // Asegurar que permita clicks si queremos interactuar
            map.getPane('heatmapPane').style.pointerEvents = 'auto';

            cargarCapas();
        }

        // --- COLORES MAPAS DE CALOR ---
        function getColorCOS(d) {
            return d > 80 ? '#800026' :
                d > 70 ? '#BD0026' :
                    d > 60 ? '#E31A1C' :
                        d > 50 ? '#FC4E2A' :
                            d > 40 ? '#FD8D3C' :
                                d > 30 ? '#FEB24C' :
                                    d > 10 ? '#FED976' :
                                        '#FFEDA0';
        }

        function getColorPisos(d) {
            return d > 12 ? '#08306b' :
                d > 8 ? '#08519c' :
                    d > 5 ? '#2171b5' :
                        d > 3 ? '#4292c6' :
                            d > 2 ? '#6baed6' :
                                d > 1 ? '#9ecae1' :
                                    '#c6dbef';
        }

        function getColorPrecio(d) {
            return d > 400 ? '#800026' :
                d > 300 ? '#BD0026' :
                    d > 200 ? '#E31A1C' :
                        d > 150 ? '#FC4E2A' :
                            d > 100 ? '#FD8D3C' :
                                d > 80 ? '#FEB24C' :
                                    d > 50 ? '#FED976' :
                                        '#FFEDA0';
        }

        async function cargarMapasCalor() {
            // 1. Validar datos base
            if (!datosParroquias || datosParroquias.length === 0) return;

            // OPTIMIZACI√ìN: Pre-procesar geometr√≠as de parroquias una sola vez
            // En lugar de hacer una "Uni√≥n" costosa, simplemente guardamos la lista de pol√≠gonos
            const poligonosParroquias = datosParroquias.map(p => turf.feature(p.geojson));

            // Fetch solo columnas necesarias
            const { data, error } = await client.from('clasificacion_suelo').select('cos, n_pisos, geometry');
            if (error) return console.error("Error heatmaps", error);
            if (!data) return;

            // Procesar y FILTRAR features
            // Estrategia "Flash": Chequeo simple contra lista de parroquias
            const features = [];
            for (const item of data) {
                if (!item.geometry) continue;

                // Crear feature temporal
                const f = turf.feature(item.geometry, { cos: item.cos, n_pisos: item.n_pisos });

                // Calcular centroide (muy r√°pido)
                const center = turf.centroid(f);

                // Chequear si el centro est√° en ALGUNA parroquia
                // Esto evita la operaci√≥n turf.union() que es muy lenta
                let isInside = false;
                for (const poly of poligonosParroquias) {
                    if (turf.booleanPointInPolygon(center, poly)) {
                        isInside = true;
                        break; // Encontramos coincidencia, pasamos al siguiente
                    }
                }

                if (isInside) {
                    features.push(f);
                }
            }

            // --- CAPA COS ---
            const cosLayer = L.geoJSON(features, {
                pane: 'heatmapPane',
                style: (feature) => ({
                    fillColor: getColorCOS(feature.properties.cos),
                    weight: 1, // Borde fino para definici√≥n
                    color: '#fff',
                    opacity: 0.5,
                    fillOpacity: 0.8 // M√°s visible
                }),
                onEachFeature: (feature, layer) => {
                    layer.bindPopup(`<b>COS:</b> ${feature.properties.cos}%`);
                }
            });
            layerControl.addOverlay(cosLayer, "üî• Mapa de Calor: COS");

            // --- CAPA PISOS ---
            const pisosLayer = L.geoJSON(features, {
                pane: 'heatmapPane',
                style: (feature) => ({
                    fillColor: getColorPisos(feature.properties.n_pisos),
                    weight: 1,
                    color: '#fff',
                    opacity: 0.5,
                    fillOpacity: 0.8 // M√°s visible
                }),
                onEachFeature: (feature, layer) => {
                    layer.bindPopup(`<b>Pisos Permitidos:</b> ${feature.properties.n_pisos}`);
                }
            });
            layerControl.addOverlay(pisosLayer, "üè¢ Mapa de Calor: Pisos");
        }

        function cargarMapaPrecioSuelo() {
            if (!datosBarrios || datosBarrios.length === 0) return;

            // Generar datos simulados de precio por barrio
            const features = datosBarrios.map(barrio => {
                // Generar precio pseudo-aleatorio basado en el nombre para consistencia
                // Rango aproximado $40 - $450
                const hash = barrio.barrio.split("").reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a }, 0);
                const precio = Math.abs(hash % 410) + 40;

                return {
                    type: "Feature",
                    properties: { ...barrio, precio_m2: precio },
                    geometry: barrio.geojson
                };
            });

            const precioLayer = L.geoJSON(features, {
                pane: 'heatmapPane',
                style: (feature) => ({
                    fillColor: getColorPrecio(feature.properties.precio_m2),
                    weight: 1,
                    color: 'white',
                    dashArray: '3',
                    opacity: 0.6,
                    fillOpacity: 0.7
                }),
                onEachFeature: (feature, layer) => {
                    layer.bindPopup(`
                        <div style="text-align:center">
                            <b>${feature.properties.barrio}</b><br>
                            <span style="color:#64748b">Precio Promedio Estimado</span><br>
                            <b style="font-size:16px; color:#16a34a">$${feature.properties.precio_m2} / m¬≤</b>
                        </div>
                    `);
                }
            });

            layerControl.addOverlay(precioLayer, "üí∞ Mapa de Calor: Precio Suelo ($/m¬≤)");
        }

        function updateLabelSize() {
            const z = map.getZoom();
            let size = '9px';
            let op = 0.9;

            // Fuentes ajustadas (sin fondo requieren ser un pelin m√°s grandes para leerse)
            if (z < 13) {
                size = '0px';
                op = 0;
            } else if (z >= 13 && z < 15) {
                size = '9px';
                op = 0.9;
            } else if (z >= 15 && z < 17) {
                size = '11px';
                op = 1;
            } else if (z >= 17) {
                size = '13px';
                op = 1;
            }

            document.documentElement.style.setProperty('--barrio-label-size', size);
            document.documentElement.style.setProperty('--barrio-label-opacity', op);
        }

        // Paleta de colores m√°s suave
        const mapColors = [
            '#e11d48', '#2563eb', '#16a34a', '#d97706', '#9333ea', '#0891b2'
        ];

        function getColor(index) {
            return mapColors[index % mapColors.length];
        }

        async function cargarCapas() {
            console.log("Cargando capas...");

            await cargarCapaParroquias();
            await cargarCapaBarrios();
            cargarMapasCalor();
            cargarMapaPrecioSuelo();
        }

        async function cargarCapaParroquias() {
            const { data, error } = await client.from('v_parroquias').select('*');
            if (error || !data) return console.error("Error parroquias", error);

            datosParroquias = data; // Guardar datos para intersecci√≥n

            const parrUnicas = data.map(d => d.nombre).sort();
            const colorMap = {};
            parrUnicas.forEach((n, i) => colorMap[n] = getColor(i));

            const features = data.map(item => ({
                type: "Feature", properties: item, geometry: item.geojson
            })).filter(f => f.geometry);

            // 1. Capa "TODAS"
            const allLayer = L.geoJSON(features, {
                style: (feature) => ({
                    color: colorMap[feature.properties.nombre] || '#475569',
                    fillColor: colorMap[feature.properties.nombre] || '#475569',
                    weight: 3,
                    dashArray: '5, 5',
                    fillOpacity: 0.1,
                    opacity: 0.8
                }),
                onEachFeature: (feature, layer) => {
                    layer.bindTooltip(feature.properties.nombre, {
                        permanent: true, direction: "center", className: "parroquia-label"
                    });
                }
            });

            allLayer.addTo(map);
            layerControl.addOverlay(allLayer, "üè¢ TODAS LAS PARROQUIAS");

            // 2. Capas Individuales
            // Agrupar features por nombre de parroquia
            const featuresByParroquia = {};
            features.forEach(f => {
                const name = f.properties.nombre;
                if (!featuresByParroquia[name]) featuresByParroquia[name] = [];
                featuresByParroquia[name].push(f);
            });

            // Crear capa para cada parroquia
            Object.keys(featuresByParroquia).sort().forEach(name => {
                const individualLayer = L.geoJSON(featuresByParroquia[name], {
                    style: {
                        color: colorMap[name] || '#475569',
                        fillColor: colorMap[name] || '#475569',
                        weight: 4,
                        fillOpacity: 0.2
                    },
                    onEachFeature: (feature, layer) => {
                        layer.bindPopup(`<b>Parroquia:</b> ${name}`);
                    }
                });
                // Usamos un prefijo para agruparlas visualmente en la lista
                layerControl.addOverlay(individualLayer, `üèòÔ∏è Barrios ${name}`);
            });
        }

        async function cargarCapaBarrios() {
            const { data, error } = await client.from('v_limites_barriales').select('*');
            if (error || !data) return console.error("Error barrios", error);

            datosBarrios = data; // Guardar globalmente para filtrado

            // Creamos la capa general "Todos" pero la mantenemos disponible
            const barriosUnicos = [...new Set(data.map(d => d.barrio))].sort();
            const colorMap = {};
            barriosUnicos.forEach((b, i) => colorMap[b] = getColor(i));

            const features = data.map(item => ({
                type: "Feature", properties: item, geometry: item.geojson
            })).filter(f => f.geometry);

            const geoJsonLayer = L.geoJSON(features, {
                style: (feature) => ({
                    color: colorMap[feature.properties.barrio] || '#333',
                    fillColor: colorMap[feature.properties.barrio] || '#333',
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.2 // Transparente
                }),
                onEachFeature: (feature, layer) => {
                    layer.on('mouseover', function (e) {
                        const l = e.target;
                        l.setStyle({ weight: 3, fillOpacity: 0.5 });
                    });

                    layer.on('mouseout', function (e) {
                        geoJsonLayer.resetStyle(e.target);
                    });

                    const p = feature.properties;
                    const contenido = `
                        <div style="font-family:'Inter',sans-serif;">
                            <h4 style="margin:0 0 5px 0; color:#cbd5e1; font-size:10px; text-transform:uppercase;">BARRIO</h4>
                            <div style="font-size:16px; font-weight:700; margin-bottom:10px; color:#ffffff;">${p.barrio}</div>
                            
                            <div style="font-size:12px;">
                                <span style="color:#94a3b8;">Parroquia:</span><br>
                                <span style="color:#f8fafc; font-weight:600;">${p.parroquia}</span>
                            </div>
                        </div>
                    `;
                    layer.bindPopup(contenido);
                }
            });

            // geoJsonLayer.addTo(map); // Eliminado para no mostrar por defecto
            // geoJsonLayer.addTo(map); // Eliminado para no mostrar por defecto
            // geoJsonLayer.addTo(map); // Eliminado para no mostrar por defecto
            layerControl.addOverlay(geoJsonLayer, "üèòÔ∏è Barrios (Todos)");
        }


        function togglePrediosVista() {
            const btn = document.getElementById('btnCatastro');
            if (map.hasLayer(prediosVistaLayer)) {
                map.removeLayer(prediosVistaLayer);
                isPrediosLayerActive = false;
                prediosVistaLayer.clearLayers();
                if (btn) {
                    btn.innerHTML = '<span class="action-icon">üó∫Ô∏è</span> <span class="action-label">Catastro<br>(Zona)</span>';
                    btn.classList.remove('active'); // NORMAL STYLE
                }
            } else {
                prediosVistaLayer.addTo(map);
                isPrediosLayerActive = true;
                cargarPrediosVista();
                if (btn) {
                    btn.innerHTML = '<span class="action-icon">üö´</span> <span class="action-label">Ocultar<br>Catastro</span>';
                    btn.classList.add('active'); // RED STYLE
                }
            }
        }

        async function verVecinos50m() {
            if (!currentData || !currentData.info_predio || !currentData.info_predio.geometry) {
                alert("Primero busca un predio.");
                return;
            }

            if (vecinosLayer) {
                map.removeLayer(vecinosLayer);
                vecinosLayer = null;
                // Si ya exist√≠a, lo quitamos (toggle)
                const btn = document.getElementById('btnVecinos');
                if (btn) {
                    btn.innerHTML = '<span class="action-icon">üèòÔ∏è</span> <span class="action-label">Vecinos<br>(50m)</span>';
                    btn.classList.remove('active');
                }
                return;
            }

            const originGeo = currentData.info_predio.geometry;
            const originFeat = turf.feature(originGeo);

            // buffer 50 metros = 0.05 km
            const buffer = turf.buffer(originFeat, 0.05, { units: 'kilometers' });

            // Estrategia IMPROVISADA POSTGIS-LIKE:
            // Como no tenemos √≠ndice espacial en el cliente ni funci√≥n RPC, usamos la CLAVE CATASTRAL.
            // Las claves catastrales suelen agrupar geogr√°ficamente (Provincia-Canton-Parroquia-Zona-Sector-Manzana...).
            // Tomamos los primeros 10 d√≠gitos de la clave para traer toda la "Zona/Sector".
            const currentClave = currentData.info_predio.clave;
            const prefix = currentClave.substring(0, 10);

            // Traemos solo los predios que coinciden en el sector (mucho m√°s r√°pido y preciso que traer todo)
            let query = client.from('predios_urbanos')
                .select('clave_cata, geometry')
                .ilike('clave_cata', `${prefix}%`); // LIKE '1101030404%'

            const { data, error } = await query;
            if (error) {
                console.error(error);
                alert("Error buscando vecinos");
                return;
            }

            // OPTIMIZACI√ìN: Pre-filtro por distancia r√°pida (Euclidiana simple)
            // Evita ejecutar turf.booleanIntersects (costoso) en predios lejanos del mismo sector
            const centerOrigin = turf.centroid(originFeat);
            const centerCoords = centerOrigin.geometry.coordinates; // [lng, lat]

            const vecinos = data.filter(p => {
                if (p.clave_cata === currentData.info_predio.clave) return false;
                if (!p.geometry) return false;

                // 1. Chequeo R√°pido de Distancia (usando primer punto del pol√≠gono)
                // Para no calcular centroides de todo, tomamos un punto de muestra
                let candidatePt;
                try {
                    // Soporte para Polygon y MultiPolygon simple
                    if (p.geometry.type === 'Polygon') candidatePt = p.geometry.coordinates[0][0];
                    else if (p.geometry.type === 'MultiPolygon') candidatePt = p.geometry.coordinates[0][0][0];
                    else return false;
                } catch (e) { return false; }

                // Distancia euclidiana aproximada (grados)
                // 1 grado lat ~= 111km. 50m = 0.05km ~= 0.00045 grados.
                // Usamos un margen seguro de 0.0015 grados (~150m) para pre-filtrar
                const dx = candidatePt[0] - centerCoords[0];
                const dy = candidatePt[1] - centerCoords[1];
                if ((dx * dx + dy * dy) > 0.000003) return false; // Saltamos los lejanos

                // 2. Si pasa el filtro r√°pido, hacemos la intersecci√≥n real
                const f = turf.feature(p.geometry);
                return turf.booleanIntersects(f, buffer);
            });

            if (vecinos.length === 0) {
                // Si no hay resultados (raro si hay contiguos), no mostramos alerta invasiva
                return;
            }

            // Dibujar
            const features = vecinos.map(v => ({
                type: "Feature", properties: v, geometry: v.geometry
            }));

            vecinosLayer = L.geoJSON(features, {
                style: {
                    color: '#f43f5e',
                    fillColor: '#f43f5e',
                    weight: 2,
                    fillOpacity: 0.4
                },
                onEachFeature: (f, l) => {
                    l.bindPopup(`<b>Vecino (50m)</b><br>${f.properties.clave_cata}`);
                }
            }).addTo(map);

            // Tambi√©n dibujar el buffer para referencia visual (opcional)
            const bufferLayer = L.geoJSON(buffer, {
                style: { color: '#94a3b8', dashArray: '5,5', fill: false, weight: 1 }
            });
            vecinosLayer.addLayer(bufferLayer); // Agrupar para borrar juntos

            map.fitBounds(vecinosLayer.getBounds());
            // Actualizar bot√≥n a estado "ON"
            const btn = document.getElementById('btnVecinos');
            if (btn) {
                btn.innerHTML = '<span class="action-icon">üö´</span> <span class="action-label">Ocultar<br>Vecinos</span>';
                btn.classList.add('active');
            }
        }


        // --- CARGA DIN√ÅMICA DE PREDIOS (VIEWPORT) ---
        async function cargarPrediosVista() {
            // Si no hay capa activa o zoom insuficiente, limpiar
            const z = map.getZoom();
            if (!isPrediosLayerActive || z < 15) { // Un poco m√°s permisivo (15)
                if (prediosVistaLayer && prediosVistaLayer.getLayers().length > 0) prediosVistaLayer.clearLayers();
                return;
            }

            // Estrategia: "SOLAMENTE DE ESE BARRIO"
            // Si hay barrios activos, filtramos por ellos.

            // Estrategia: "SOLAMENTE DE ESE BARRIO"
            // Si activeBarrioNames tiene elementos, usamos filtro.
            // Si NO tiene elementos (size === 0), Mostramos TODO (Default).

            const barriosFilter = activeBarrioNames.size > 0 ? Array.from(activeBarrioNames) : null;

            console.log("Cargando predios. Filtro:", barriosFilter || "TODOS");

            const b = map.getBounds();
            const { data, error } = await client.rpc('get_predios_in_view', {
                min_lon: b.getWest(),
                min_lat: b.getSouth(),
                max_lon: b.getEast(),
                max_lat: b.getNorth(),
                barrios_names: barriosFilter
            });

            if (error) {
                console.error("Error viewport predios:", error);
                return;
            }

            if (data) {
                prediosVistaLayer.clearLayers(); // Limpiar previo
                const features = data.map(d => ({
                    type: "Feature",
                    properties: { clave: d.clave_cata },
                    geometry: d.geometry
                }));

                const layer = L.geoJSON(features, {
                    style: {
                        color: '#000000',      // Borde Negro
                        weight: 0.8,           // Fino
                        fillColor: '#86efac',  // Verde (Green-300)
                        fillOpacity: 1         // Solido
                    },
                    onEachFeature: (feature, layer) => {
                        layer.bindPopup(`<b style="color:black">${feature.properties.clave}</b>`);
                        layer.on('click', () => {
                            document.getElementById('claveInput').value = feature.properties.clave;
                            buscarPredio();
                        });
                    }
                });
                if (prediosVistaLayer) {
                    prediosVistaLayer.clearLayers();
                    prediosVistaLayer.addLayer(layer);
                }
            } else {
                console.log("No data returned from RPC");
            }
        }

        // --- FUNCIONES NUEVAS PARA GESTI√ìN DE BARRIOS POR PARROQUIA ---
        function mostrarBarriosDeParroquia(nombreParroquia) {
            if (!datosBarrios || datosBarrios.length === 0) return;

            // Si ya est√° mostrada, no hacer nada
            if (activeBarrioLayers[nombreParroquia]) return;

            // Filtrar barrios
            const barriosFiltrados = datosBarrios.filter(b => b.parroquia === nombreParroquia);
            if (barriosFiltrados.length === 0) return;

            // ACTUALIZAR LISTA DE BARRIOS ACTIVOS
            barriosFiltrados.forEach(b => activeBarrioNames.add(b.barrio));
            // RECARGAR PREDIOS CON NUEVO FILTRO
            cargarPrediosVista();

            // Crear features
            const features = barriosFiltrados.map(item => ({
                type: "Feature", properties: item, geometry: item.geojson
            })).filter(f => f.geometry);

            const colorMap = {}; // Reusar o simplificar
            // Generar colores consistentes
            features.forEach((f, i) => {
                // Un simple hash o √≠ndice para color
                colorMap[f.properties.barrio] = getColor(i);
            });

            const layer = L.geoJSON(features, {
                style: (feature) => ({
                    color: '#ffffff', // Borde blanco para resaltar sobre la parroquia
                    weight: 1,
                    dashArray: '2, 4',
                    fillColor: getColor(feature.properties.barrio.length), // Color aleatorio deterministic
                    fillOpacity: 0.3
                }),
                onEachFeature: (feature, layer) => {
                    // Etiqueta SIEMPRE VISIBLE
                    layer.bindTooltip(`<span>${feature.properties.barrio}</span>`, {
                        permanent: true,
                        direction: "center",
                        className: "barrio-label",
                        opacity: 1
                    });

                    layer.bindPopup(`
                        <div style="text-align:center;">
                            <small style="color:#94a3b8">Barrio</small><br>
                            <b style="font-size:14px; color:#38bdf8">${feature.properties.barrio}</b>
                        </div>
                    `);

                    // Hover effect
                    layer.on('mouseover', function (e) {
                        e.target.setStyle({ weight: 3, fillOpacity: 0.6, color: '#facc15' });
                        e.target.bringToFront();
                    });
                    layer.on('mouseout', function (e) {
                        layer.resetStyle(e.target);
                    });
                }
            });

            layer.addTo(map);
            activeBarrioLayers[nombreParroquia] = layer;
        }

        function ocultarBarriosDeParroquia(nombreParroquia) {
            const layer = activeBarrioLayers[nombreParroquia];
            if (layer) {
                map.removeLayer(layer);
                delete activeBarrioLayers[nombreParroquia];

                // REMOVER BARRIOS DE LA LISTA ACTIVA
                // Ojo: Si un barrio pertenece a varias capas (raro pero posible), esto lo quitar√≠a.
                // Asumimos barrio √∫nico por parroquia.
                const barriosFiltrados = datosBarrios.filter(b => b.parroquia === nombreParroquia);
                barriosFiltrados.forEach(b => activeBarrioNames.delete(b.barrio));

                // RECARGAR PREDIOS
                cargarPrediosVista();
            }
        }

        function limpiarMapa() {
            if (predioLayer) map.removeLayer(predioLayer);
            document.getElementById('claveInput').value = '';
            document.getElementById('resultsPanel').innerHTML = '<div class="empty-state">Ingresa clave...</div>';

            // Limpiar y ocultar panel derecho
            const rp = document.getElementById('rightPanel');
            if (rp) {
                rp.innerHTML = '';
                rp.style.display = 'none';
            }

            currentData = null;
        }

        async function buscarPredio() {
            const clave = document.getElementById('claveInput').value.trim();
            if (!clave) return alert("Ingrese una clave catastral");

            const btn = document.querySelector('.btn-search');
            btn.innerText = "‚è≥ Buscando...";
            btn.disabled = true;

            const { data, error } = await client.rpc('obtener_reporte_predio', { clave_catastral: clave });

            btn.innerText = "üîç Consultar Predio";
            btn.disabled = false;

            if (error || !data) {
                mostrarError("No se encontr√≥ informaci√≥n o hubo un error.");
                return;
            }

            if (!data.info_predio) {
                mostrarError("Clave no encontrada en el sistema.");
                return;
            }

            currentData = data;
            console.log("Datos recibidos:", data);

            mostrarResultados(data);
            dibujarPredio(data);
        }

        // --- BUSCADOR INTELIGENTE DE COORDENADAS ---
        let marcadorBusqueda = null;

        async function buscarPorCoordenadas() {
            const input = document.getElementById('coordInput').value.trim();
            if (!input) return alert("Pega un link de Google Maps o coordenadas.");

            let lat = null, lon = null;

            // 1. Intentar Coordenadas Decimales (ej: -4.00, -79.20)
            // Regex: Busca dos n√∫meros flotantes separados por coma o espacio
            const decimalRegex = /(-?\d+\.\d+)[,\s]+(-?\d+\.\d+)/;
            const decimalMatch = input.match(decimalRegex);

            if (decimalMatch) {
                // Verificar orden. Google suele ser Lat, Lon. Pero GeoJSON es Lon, Lat.
                // Asumimos Lat, Lon para inputs humanos comunes en esta zona.
                // Validamos rango ecuador: Lat ~ -4, Lon ~ -79
                let v1 = parseFloat(decimalMatch[1]);
                let v2 = parseFloat(decimalMatch[2]);

                // Heur√≠stica simple para Loja: Lat es el peque√±o (-3 a -5), Lon es el grande (-79...)
                if (Math.abs(v1) > Math.abs(v2)) { [v1, v2] = [v2, v1]; } // Swap si v1 parece longitud

                lat = v1; lon = v2;
            }

            // 2. Intentar Link Largo Google Maps (ej: .../maps/@-3.99,-79.20,15z...)
            if (!lat) {
                const googleMapsRegex = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
                const gmMatch = input.match(googleMapsRegex);
                if (gmMatch) {
                    lat = parseFloat(gmMatch[1]);
                    lon = parseFloat(gmMatch[2]);
                }
            }

            // 3. Intentar Link "place" Google Maps (ej: .../place/Lat+Lon/@...)
            // A veces viene como .../place/3¬∞59'50.4"S+79¬∞12'22.5"W/...
            if (!lat) {
                // Esto es complejo de parsear directo de URL encoded, pero intentemos buscar DMS en el texto
                // Regex DMS simple: 3¬∞59'50.4"S 
                // Convertir a decimal es tedioso, probemos si hay decimales escondidos en la URL (suelen estar en el @ o en !3d..!4d..)

                // !3d-3.9973428!4d-79.2062454
                const dataParamRegex = /!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/;
                const dataMatch = input.match(dataParamRegex);
                if (dataMatch) {
                    lat = parseFloat(dataMatch[1]);
                    lon = parseFloat(dataMatch[2]);
                }
            }

            // 4. Intentar Coordenadas DMS (Grados Minutos Segundos)
            // ej: 3¬∞59'50.4"S 79¬∞12'22.5"W
            if (!lat) {
                // Parseador muy b√°sico para formato comun
                try {
                    const dmsRegex = /(\d+)¬∞(\d+)'([\d.]+)"([NS])[\s,]+(\d+)¬∞(\d+)'([\d.]+)"([EW])/i;
                    const dmsMatch = input.match(dmsRegex);
                    if (dmsMatch) {
                        // Lat
                        let d1 = parseFloat(dmsMatch[1]), m1 = parseFloat(dmsMatch[2]), s1 = parseFloat(dmsMatch[3]), h1 = dmsMatch[4].toUpperCase();
                        lat = d1 + m1 / 60 + s1 / 3600;
                        if (h1 === 'S') lat = -lat;

                        // Lon
                        let d2 = parseFloat(dmsMatch[5]), m2 = parseFloat(dmsMatch[6]), s2 = parseFloat(dmsMatch[7]), h2 = dmsMatch[8].toUpperCase();
                        lon = d2 + m2 / 60 + s2 / 3600;
                        if (h2 === 'W') lon = -lon;
                    }
                } catch (e) { console.log("Error DMS", e); }
            }

            // Validaci√≥n Final
            if (lat && lon && !isNaN(lat) && !isNaN(lon)) {
                // Mover mapa
                map.setView([lat, lon], 19);

                // Marcador Simple
                if (marcadorBusqueda) map.removeLayer(marcadorBusqueda);
                marcadorBusqueda = L.marker([lat, lon]).addTo(map)
                    .bindPopup(`<b>üìç Ubicaci√≥n</b><br>Lat: ${lat.toFixed(6)}<br>Lon: ${lon.toFixed(6)}`)
                    .openPopup();

            } else {
                alert("No pude entender esa ubicaci√≥n. üòì\n\nIntenta copiar coordenadas decimales (ej: -4.00, -79.20) o asegurarte que el link tenga n√∫meros visibles.");
            }
        }

        function mostrarError(msg) {
            document.getElementById('resultsPanel').innerHTML =
                `<div class="empty-state" style="color:#ef4444">‚ùå ${msg}</div>`;
            document.getElementById('statusText').innerText = "Error";
        }

        function mostrarResultados(d) {
            const i = d.info_predio;
            const u = d.ubicacion || {};
            const n = d.normativa || {};
            const r = d.riesgos || {};

            let usoSuelo = n.uso_principal || n.uso_general || "NO DEFINIDO";
            if (!isNaN(usoSuelo) && n.uso_general) usoSuelo = n.uso_general;

            // Logic for indicators
            let costM2 = 180; // Default El Valle
            if (u.nombre_parroquia && u.nombre_parroquia.includes("CENTRO")) costM2 = 450;
            if (u.nombre_parroquia && u.nombre_parroquia.includes("PUNZARA")) costM2 = 120;

            const precioLote = (i.area_escritura * costM2).toLocaleString('en-US', { style: 'currency', currency: 'USD' });

            const html = `
                    <!-- Info Unificada Lista (Minimalista) -->
                    <div class="info-card" style="margin-bottom:0;">
                        <!-- Encabezado con Clave y √Årea -->
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; border-bottom:1px solid #334155; padding-bottom:8px;">
                            <span style="font-size:12px; color:#38bdf8; font-weight:700;">Clave: ${i.clave}</span>
                            <span style="font-size:13px; color:#f8fafc; font-weight:700;">${i.area_escritura.toFixed(0)} m¬≤</span>
                        </div>
                        
                        <!-- Lista de Datos Homog√©nea -->
                        <div class="data-row" style="margin-bottom:5px;">
                            <span class="data-label">Ubicaci√≥n:</span> 
                            <span class="data-value" style="font-size:11px; text-align:right; color:#f1f5f9;">${u.nombre_barrio || 'S/N'}, ${u.nombre_parroquia || 'S/D'}</span>
                        </div>
                        
                        <div class="data-row" style="margin-bottom:5px;">
                             <span class="data-label">Uso Suelo:</span> 
                             <span class="data-value" style="font-size:11px; text-align:right; color:#f1f5f9;">${usoSuelo}</span>
                        </div>

                        <div class="data-row" style="margin-bottom:5px;">
                             <span class="data-label">Altura m√°x. pisos:</span> 
                             <span class="data-value" style="font-size:11px; text-align:right; color:#f1f5f9;">${n.n_pisos || 0} Pisos</span>
                        </div>

                        <div class="data-row" style="margin-bottom:0;">
                             <span class="data-label">COS PB:</span> 
                             <span class="data-value" style="font-size:11px; text-align:right; color:#f1f5f9;">${n.cos || 0}%</span>
                        </div>
                    </div>
                    </div>

                    <!-- Botones de Acci√≥n en Grid (2 Filas x 3 Columnas) -->
                    <div class="action-grid">
                        <div class="action-btn" onclick="generarReporte()">
                            <span class="action-icon">üìÑ</span>
                            <span class="action-label">Informe<br>T√©cnico</span>
                        </div>
                        <div class="action-btn" onclick="generarPlanimetria()">
                            <span class="action-icon">üìê</span>
                            <span class="action-label">Generar<br>Planimetr√≠a</span>
                        </div>
                        <div class="action-btn" onclick="abrirCalculadora()">
                            <span class="action-icon">üßÆ</span>
                            <span class="action-label">Calculadora<br>Edificable</span>
                        </div>
                        <div class="action-btn" onclick="generarReporteCiudadano()">
                            <span class="action-icon">üëã</span>
                            <span class="action-label">Reporte<br>Ciudadano</span>
                        </div>
                        <div class="action-btn" id="btnVecinos" onclick="verVecinos50m()">
                            <span class="action-icon">üèòÔ∏è</span>
                            <span class="action-label">Vecinos<br>(50m)</span>
                        </div>
                        <div class="action-btn" id="btnCatastro" onclick="togglePrediosVista()">
                            <span class="action-icon">üó∫Ô∏è</span>
                            <span class="action-label">Catastro<br>(Zona)</span>
                        </div>
                    </div>
                `;
            document.getElementById('resultsPanel').innerHTML = html;
            document.getElementById('statusText').innerText = "Datos cargados: " + i.clave;

            // --- LIMPIAR PANEL DERECHO (Ya no se usa) ---
            const rp = document.getElementById('rightPanel');
            if (rp) {
                rp.innerHTML = '';
                rp.style.display = 'none';
            }

            // Re-aplicar clases para animacion si se desea, o simple display
            // Auto expandir en m√≥vil
            const sb = document.getElementById('sidebar');
            if (window.innerWidth <= 768) {
                sb.classList.remove('minimized');
                const toggle = sb.querySelector('.mobile-toggle');
                if (toggle) toggle.style.transform = 'rotate(0deg)';
            }
        }

        function dibujarPredio(data) {
            const geojson = data.info_predio.geometry;
            const i = data.info_predio;
            const u = data.ubicacion || {};
            const n = data.normativa || {};
            const r = data.riesgos || {};

            if (!geojson) return;
            if (predioLayer) map.removeLayer(predioLayer);

            const coords = geojson.coordinates[0].map(c => [c[1], c[0]]);
            predioLayer = L.polygon(coords, {
                color: '#f59e0b', weight: 4, fillColor: '#f59e0b', fillOpacity: 0.6
            }).addTo(map);

            // Calcular Centroide para UTM
            let cx = 0, cy = 0;
            const pts = geojson.coordinates[0];
            pts.forEach(p => { cx += p[0]; cy += p[1]; });
            cx /= pts.length;
            cy /= pts.length;

            let utmX = "N/D", utmY = "N/D";
            if (typeof proj4 !== 'undefined') {
                // Asegurar que la proyecci√≥n est√© definida
                if (!proj4.defs("EPSG:32717")) {
                    proj4.defs("EPSG:32717", "+proj=utm +zone=17 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs");
                }
                try {
                    const utm = proj4("EPSG:4326", "EPSG:32717", [cx, cy]);
                    utmX = utm[0].toFixed(2);
                    utmY = utm[1].toFixed(2);
                } catch (e) { console.error("Error Proj4", e); }
            }

            // Determinar Uso de Suelo
            let usoSuelo = n.uso_principal || n.uso_general || "NO DEFINIDO";
            if (!isNaN(usoSuelo) && n.uso_general) usoSuelo = n.uso_general;

            const popupContent = `
                <div style = "font-family:'Inter',sans-serif; min-width: 260px;" >
                    <h3 style="margin:0 0 10px 0; color:#cbd5e1; font-size:12px; text-transform:uppercase; border-bottom: 1px solid #475569; padding-bottom: 5px;">INFORMACI√ìN DEL PREDIO</h3>
                    
                    <div style="display:grid; grid-template-columns: 1fr; gap:8px; font-size:12px;">
                        <div style="background:#0f172a; padding:8px; border-radius:4px; border:1px solid #334155;">
                            <span style="color:#94a3b8; font-size:10px; text-transform:uppercase;">Clave Catastral:</span><br>
                            <span style="color:#f8fafc; font-weight:700; font-size:14px;">${i.clave}</span>
                        </div>

                        <!-- Uso de Suelo Destacado -->
                        <div style="background:#312e81; padding:8px; border-radius:4px; border:1px solid #4f46e5; margin-bottom:5px;">
                            <span style="color:#a5b4fc; font-size:10px; text-transform:uppercase; font-weight:700;"> USO DE SUELO:</span><br>
                            <span style="color:#e0e7ff; font-weight:800; font-size:12px; text-transform:uppercase;">${usoSuelo}</span>
                        </div>
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                             <div>
                                <span style="color:#94a3b8;">Parroquia:</span><br>
                                <span style="color:#f8fafc; font-weight:600;">${u.nombre_parroquia || 'N/D'}</span>
                             </div>
                             <div>
                                <span style="color:#94a3b8;">Barrio:</span><br>
                                <span style="color:#f8fafc; font-weight:600;">${u.nombre_barrio || 'N/D'}</span>
                             </div>
                        </div>

                         <!-- Coordenadas UTM -->
                        <div style="background:#1e293b; padding:5px; border-top:1px dashed #475569; border-bottom:1px dashed #475569;">
                             <div style="display:flex; justify-content:space-between;">
                                <div><span style="color:#94a3b8; font-size:10px;">UTM ESTE (X):</span> <b style="color:#38bdf8;">${utmX}</b></div>
                                <div><span style="color:#94a3b8; font-size:10px;">UTM NORTE (Y):</span> <b style="color:#38bdf8;">${utmY}</b></div>
                             </div>
                        </div>

                        <div>
                            <span style="color:#94a3b8;">√Årea del Predio:</span><br>
                            <span style="color:#f8fafc; font-weight:600;">${i.area_escritura.toFixed(2)} m¬≤</span>
                        </div>

                         <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                             <div>
                                <span style="color:#94a3b8;">Altura M√°x:</span><br>
                                <span style="color:#f8fafc; font-weight:600;">${n.n_pisos || 0} Pisos</span>
                             </div>
                             <div>
                                <span style="color:#94a3b8;">Retiro Frontal:</span><br>
                                <span style="color:#f8fafc; font-weight:600;">${n.retiro_fron || 0} m</span>
                             </div>
                        </div>

                         <div style="margin-top:5px; border-top: 1px dashed #475569; padding-top:5px;">
                            <span style="color:#94a3b8;">Aptitud:</span><br>
                            <span style="color:#10b981; font-weight:700;">${r.aptitud || 'Sin dato'}</span>
                        </div>

                        <div>
                            <span style="color:#94a3b8;">Amenazas:</span><br>
                            <span style="color:#f59e0b; font-weight:600; font-size:11px;">${r.amenazas || 'Ninguna'}</span>
                        </div>
                        
                        <div>
                            <span style="color:#94a3b8;">Estudios Requeridos:</span><br>
                            <span style="color:#38bdf8; font-weight:600; font-size:11px;">${r.estudios || 'Ninguno'}</span>
                        </div>
                    </div>
                </div>
                `;

            predioLayer.bindPopup(popupContent); // Se elimin√≥ .openPopup()

            map.fitBounds(predioLayer.getBounds(), { padding: [80, 80], maxZoom: 18 });
        }

        function limpiarMapa() {
            if (predioLayer) map.removeLayer(predioLayer);
            document.getElementById('claveInput').value = '';
            document.getElementById('resultsPanel').innerHTML = '<div class="empty-state">Ingresa clave...</div>';

            // Limpiar y ocultar panel derecho
            const rp = document.getElementById('rightPanel');
            rp.innerHTML = '';
            rp.style.display = 'none';

            currentData = null;
        }

        // --- GENERACI√ìN DE REPORTE ---
        function generarReporte() {
            if (!currentData) return;
            const d = currentData;
            const modal = document.getElementById('reportModal');
            document.getElementById('reportDate').innerText = new Date().toLocaleString();

            const n = d.normativa || {};
            const u = d.ubicacion || {};
            const vias = d.vias || [];

            let usoTexto = n.uso_principal || n.uso_general || "NO DEFINIDO";

            let aguaTexto = "NO DETECTADA EN RED P√öBLICA";
            if (d.agua_potable && d.agua_potable.tiene_red) {
                const mat = d.agua_potable.material ? d.agua_potable.material : 'Red P√∫blica';
                const diam = d.agua_potable.diametro ? `(${d.agua_potable.diametro} mm)` : '';
                aguaTexto = `SI TIENE - ${mat} ${diam} `;
            }

            let viasHtml = vias.length > 0
                ? vias.map(v => `<li> ${v.nombre} (Ancho: ${v.ancho_total}m, Calzada: ${v.ancho_calzada}m)</li> `).join('')
                : "<li>No se identifican v√≠as principales en la base de datos vial.</li>";

            const html = `
                <div style = "margin-bottom: 20px; display:flex; justify-content:space-between; border-bottom: 2px solid #333; padding-bottom: 10px;" >
                        <div>
                            <strong>CLAVE CATASTRAL:</strong> ${d.info_predio.clave}<br>
                            <strong>√ÅREA GR√ÅFICA:</strong> ${d.info_predio.area_escritura.toFixed(2)} m¬≤
                        </div>
                        <div style="text-align:right;">
                            <strong>PARROQUIA:</strong> ${u.nombre_parroquia || 'Desconocida'}<br>
                            <strong>BARRIO:</strong> ${u.nombre_barrio || 'S/N'}
                        </div>
                    </div>

                    <div id="miniMap"></div>

                    <div class="report-grid">
                        <div class="technical-box">
                            <div class="box-title">1. OCUPACI√ìN DEL SUELO (NORMATIVA)</div>
                            <div class="box-content">
                                <div class="report-row"><span class="report-label">Clasificaci√≥n:</span> <span class="report-val">${n.clasificacion || '-'}</span></div>
                                <div class="report-row"><span class="report-label">Subclasificaci√≥n:</span> <span class="report-val">${n.subclasificacion || '-'}</span></div>
                                <div class="report-row"><span class="report-label">Categor√≠a:</span> <span class="report-val">${n.categoria || '-'}</span></div>
                                <div class="report-row"><span class="report-label">PIT / Pol√≠gono:</span> <span class="report-val">${n.pit || '-'}</span></div>
                                <hr style="margin:5px 0; border:0; border-top:1px dashed #ccc;">
                                <div class="report-row"><span class="report-label">Uso Principal:</span> <span class="report-val">${usoTexto}</span></div>
                                <div class="report-row"><span class="report-label">Uso Prohibido:</span> <span class="report-val">${n.uso_prohibido || 'Ninguno'}</span></div>
                            </div>
                        </div>

                        <div class="technical-box">
                            <div class="box-title">2. EDIFICABILIDAD Y RETIROS</div>
                            <div class="box-content">
                                <div class="report-row"><span class="report-label">Lote M√≠nimo:</span> <span class="report-val">${n.lote_min || '-'} m¬≤</span></div>
                                <div class="report-row"><span class="report-label">Frente M√≠nimo:</span> <span class="report-val">${n.frente_min || '-'} m</span></div>
                                <div class="report-row"><span class="report-label">COS PB:</span> <span class="report-val">${n.cos || 0}%</span></div>
                                <div class="report-row"><span class="report-label">CUS Total:</span> <span class="report-val">${n.cus || 0}%</span></div>
                                <div class="report-row"><span class="report-label">No. Pisos:</span> <span class="report-val">${n.n_pisos || 0}</span></div>
                                <hr style="margin:5px 0; border:0; border-top:1px dashed #ccc;">
                                <div class="report-row"><span class="report-label">Retiro Frontal:</span> <span class="report-val">${n.retiro_fron || 0} m</span></div>
                                <div class="report-row"><span class="report-label">Retiro Lateral:</span> <span class="report-val">${n.retiro_lat || 0} m</span></div>
                                <div class="report-row"><span class="report-label">Retiro Posterior:</span> <span class="report-val">${n.retiro_pos || 0} m</span></div>
                            </div>
                        </div>

                        <div class="technical-box">
                            <div class="box-title">3. INFRAESTRUCTURA B√ÅSICA Y VIALIDAD</div>
                            <div class="box-content">
                                <div class="report-row"><span class="report-label">Agua Potable:</span> <span class="report-val" style="font-weight:bold;">${aguaTexto}</span></div>
                                <div class="report-row"><span class="report-label">Alcantarillado:</span> <span class="report-val">NO TIENE (Ref. BD)</span></div>
                                <p style="margin-top:5px; font-weight:bold; font-size:11px;">V√≠as Colindantes:</p>
                                <ul style="padding-left:15px; font-size:10px;">${viasHtml}</ul>
                            </div>
                        </div>

                        <div class="technical-box">
                            <div class="box-title">4. RIESGOS Y PATRIMONIO</div>
                            <div class="box-content">
                                <div class="report-row"><span class="report-label">Aptitud:</span> <span class="report-val">${d.riesgos ? d.riesgos.aptitud : 'Sin Estudio'}</span></div>
                                <div class="report-row"><span class="report-label">Amenazas:</span> <span class="report-val">${d.riesgos ? d.riesgos.amenazas : 'Ninguna'}</span></div>
                                <div class="report-row"><span class="report-label">Estudios:</span> <span class="report-val" style="font-size:9px;">${d.riesgos ? d.riesgos.estudios : '-'}</span></div>
                                <hr style="margin:5px 0; border:0; border-top:1px dashed #ccc;">
                                <div class="report-row"><span class="report-label">Zona Patrimonial:</span> <span class="report-val">${d.patrimonio ? d.patrimonio.zona : 'NO APLICA'}</span></div>
                            </div>
                        </div>
                    </div>
            `;

            document.getElementById('reportContent').innerHTML = html;
            modal.classList.add('active');

            setTimeout(() => {
                if (reportMap) { reportMap.remove(); }
                reportMap = L.map('miniMap', { zoomControl: false, attributionControl: false });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(reportMap);

                const coords = d.info_predio.geometry.coordinates[0].map(c => [c[1], c[0]]);
                const poly = L.polygon(coords, { color: 'black', fillOpacity: 0.2, weight: 2 }).addTo(reportMap);
                reportMap.fitBounds(poly.getBounds());
            }, 500);
        }

        function cerrarReporte() {
            document.getElementById('reportModal').classList.remove('active');
        }

        function cerrarPlanimetria() {
            document.getElementById('planimetriaModal').classList.remove('active');
        }

        function cerrarReporteCiudadano() {
            document.getElementById('ciudadanoModal').classList.remove('active');
        }

        async function generarReporteCiudadano() {
            if (!currentData) return;

            const i = currentData.info_predio;
            const n = currentData.normativa || {};
            const r = currentData.riesgos || {}; // Definir riesgos
            const area = i.area_escritura;
            const cos = n.cos || 0;
            const pisos = n.n_pisos || 0;
            const retiroFron = n.retiro_fron || 0;

            // C√°lculos Amigables
            const areaPB = (area * (cos / 100)).toFixed(1);
            const areaTotalConstr = (area * (n.cus ? n.cus / 100 : (cos / 100 * pisos))).toFixed(1);

            // Estimaci√≥n Impuesto (Heur√≠stica: Valor Terreno Base $50/m2 * √Årea * 0.15% tasa ejemplo)
            const valorEstimadoTerreno = area * 60; // $60/m2 promedio referencial
            const impuestoEstimado = (valorEstimadoTerreno * 0.0015).toFixed(2); // 1.5 por mil

            // --- C√ÅLCULO DE SCORE DE ENTORNO (0-10) ---
            let score = 5.0; // Base
            let factoresPositivos = [];
            let factoresNegativos = [];

            // 1. Riesgos (+/- 4 pts)
            const aptitud = (r.aptitud || "").toUpperCase();
            if (aptitud.includes("APTA")) {
                score += 3.0;
                factoresPositivos.push("‚úÖ Zona Geol√≥gicamente Estable (Apta)");
            } else if (aptitud.includes("CONDICIONADA")) {
                score += 1.5;
                factoresNegativos.push("‚ö†Ô∏è Zona Condicionada (Requiere Estudios)");
            } else {
                score -= 2.0;
                factoresNegativos.push("‚õî Restricciones por Riesgo");
            }

            if (!r.amenazas || r.amenazas === 'Ninguna' || r.amenazas === 'N/D') {
                score += 1.0;
            } else {
                score -= 0.5;
                factoresNegativos.push(`‚ö†Ô∏è Amenaza Identificada: ${r.amenazas} `);
            }

            // 2. Normativa y Potencial (+/- 3 pts)
            if (pisos >= 3) { score += 1.0; factoresPositivos.push(`üèôÔ∏è Permite altura media(${pisos} pisos)`); }
            if (pisos >= 5) { score += 0.5; }
            if (cos >= 60) { score += 0.5; factoresPositivos.push("üìê Buen aprovechamiento de suelo en PB"); }

            // 3. Ubicaci√≥n y Servicios (Proxy)
            if (currentData.ubicacion && currentData.ubicacion.nombre_barrio) {
                score += 1.0;
                factoresPositivos.push("üìç Barrio Consolidado / Urbano");
            }

            // Clamp 0-10
            score = Math.min(Math.max(score, 1), 10).toFixed(1);

            // Color seg√∫n score
            let colorScore = score >= 8 ? '#16a34a' : (score >= 5 ? '#d97706' : '#dc2626');
            let mensajeScore = score >= 8 ? 'Excelente Oportunidad' : (score >= 5 ? 'Propiedad Est√°ndar' : 'Requiere Atenci√≥n');

            let html = `
                <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 30px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); color: white; display: flex; align-items: center; justify-content: space-between; gap:20px;">
                    <div>
                        <h3 style="color: #94a3b8; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Score de Atractivo</h3>
                        <div style="font-size: 48px; font-weight: 800; color: ${colorScore}; line-height: 1;">${score}<span style="font-size: 24px; color: #64748b;">/10</span></div>
                        <div style="font-size: 18px; font-weight: 600; color: ${colorScore}; margin-bottom: 10px;">${mensajeScore}</div>
                        <p style="color: #94a3b8; font-size: 12px; max-width: 300px;">
                            Calculado en base a seguridad geol√≥gica, potencial constructivo y ubicaci√≥n consolidada.
                        </p>
                    </div>
                    
                    <div style="flex: 1; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                        <strong style="color: #e2e8f0; display: block; margin-bottom: 10px; font-size: 13px;">Factores Clave:</strong>
                        <ul style="list-style: none; padding: 0; margin: 0; font-size: 12px; display: grid; gap: 8px;">
                            ${factoresPositivos.map(f => `<li style="color: #86efac;">${f}</li>`).join('')}
                            ${factoresNegativos.map(f => `<li style="color: #fca5a5;">${f}</li>`).join('')}
                        </ul>
                    </div>
                </div>

                
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-left: 5px solid #10b981;">
                    <h3 style="color: #065f46; font-size: 20px; display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                        üèóÔ∏è ¬øQu√© puedo construir?
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: #ecfdf5; padding: 15px; border-radius: 8px;">
                            <div style="font-size:32px; margin-bottom:10px;">üìê</div>
                            <strong style="color: #047857; display:block; margin-bottom:5px;">√Årea √ötil en PB (COS):</strong>
                            <p style="color: #334155; font-size: 14px; margin:0;">
                                Puedes ocupar hasta <strong>${areaPB} m¬≤</strong> del terreno en el primer piso.
                                <br><span style="font-size:12px; color:#64748b;">(El resto es patio/retiro)</span>
                            </p>
                        </div>

                        <div style="background: #ecfdf5; padding: 15px; border-radius: 8px;">
                            <div style="font-size:32px; margin-bottom:10px;">üèóÔ∏è</div>
                            <strong style="color: #047857; display:block; margin-bottom:5px;">√Årea Total Construcci√≥n:</strong>
                            <p style="color: #334155; font-size: 14px; margin:0;">
                                En total (sumando todos los pisos) podr√≠as construir hasta <strong>${areaTotalConstr} m¬≤</strong> aproximados.
                            </p>
                        </div>
                        
                        <div style="background: #ecfdf5; padding: 15px; border-radius: 8px; grid-column: span 2;">
                            <div style="font-size:32px; margin-bottom:10px;">üè¢</div>
                            <strong style="color: #047857; display:block; margin-bottom:5px;">Altura Permitida:</strong>
                            <p style="color: #334155; font-size: 14px; margin:0;">
                                Puedes levantar una edificaci√≥n de hasta <strong>${pisos} pisos</strong>.
                            </p>
                        </div>
                    </div>
                </div>

                
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-left: 5px solid #f59e0b;">
                    <h3 style="color: #92400e; font-size: 20px; display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                        üöß Espacios Libres (Retiros)
                    </h3>
                    <p style="color: #475569; font-size: 15px;">
                        Tu terreno debe dejar un espacio libre al frente (hacia la calle) de <strong>${retiroFron} metros</strong>.
                        <br>
                        <em>Imagina que el √°rea √∫til real es tu terreno menos estos bordes obligatorios.</em>
                    </p>
                </div>

                
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-left: 5px solid #3b82f6;">
                    <h3 style="color: #1e40af; font-size: 20px; display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                        üí∞ Estimador de Impuestos
                    </h3>
                    <div style="background: #eff6ff; padding: 20px; border-radius: 8px; text-align: center;">
                        <span style="font-size: 36px; font-weight: 800; color: #2563eb;">$${impuestoEstimado}</span>
                        <p style="color: #64748b; font-size: 12px; margin-top: 10px;">
                            *Valor referencial estimado anual. Puede variar significativamente seg√∫n el aval√∫o real municipal y las construcciones existentes.
                        </p>
                    </div>
                </div>

                <!-- SECCI√ìN INMOBILIARIA/INVERSIONISTA -->
                <div style="background: linear-gradient(to right, #f8fafc, #f1f5f9); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; margin-top: 20px;">
                     <h3 style="color: #0f172a; font-size: 20px; display:flex; align-items:center; gap:10px; margin-bottom:20px;">
                        üìä An√°lisis de Inversi√≥n (Inmobiliaria)
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- Columna Izq: Datos Financieros (Heur√≠stica) -->
                        <div>
                             <h4 style="font-size: 14px; text-transform: uppercase; color: #64748b; margin-bottom: 10px;">Proyecci√≥n Financiera (Estimada)</h4>
                             <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                                <tr style="border-bottom: 1px dashed #cbd5e1;">
                                    <td style="padding: 8px 0; color: #475569;">Potencial Construcci√≥n Total:</td>
                                    <td style="padding: 8px 0; font-weight: 700; text-align: right; color: #0f172a;">${areaTotalConstr} m¬≤</td>
                                </tr>
                                <tr style="border-bottom: 1px dashed #cbd5e1;">
                                    <td style="padding: 8px 0; color: #475569;">Costo Aprox. Construcci√≥n ($500/m¬≤):</td>
                                    <td style="padding: 8px 0; font-weight: 700; text-align: right; color: #ef4444;">$${(areaTotalConstr * 500).toLocaleString()}</td>
                                </tr>
                                <tr style="border-bottom: 1px dashed #cbd5e1;">
                                    <td style="padding: 8px 0; color: #475569;">Venta Estimada ($900/m¬≤):</td>
                                    <td style="padding: 8px 0; font-weight: 700; text-align: right; color: #10b981;">$${(areaTotalConstr * 900).toLocaleString()}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px 0; font-weight: 700; color: #334155;">Utilidad Bruta Proyectada:</td>
                                    <td style="padding: 12px 0; font-weight: 800; text-align: right; color: #16a34a;">$${((areaTotalConstr * 900) - (areaTotalConstr * 500)).toLocaleString()}</td>
                                </tr>
                             </table>
                             <p style="font-size: 10px; color: #94a3b8; margin-top: 5px;">*Valores referenciales de mercado (Obra Gris/Terminados). No constituye aval√∫o comercial.</p>
                        </div>

                        <!-- Columna Der: Potencial Inmobiliario -->
                        <div>
                            <h4 style="font-size: 14px; text-transform: uppercase; color: #64748b; margin-bottom: 10px;">Ficha T√©cnica Comercial</h4>
                            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color:#64748b; font-size:12px;">Unidades de Vivienda (Aprox 85m¬≤):</span>
                                    <strong style="color:#334155;">~${Math.floor(areaTotalConstr / 100)} Unidades</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color:#64748b; font-size:12px;">Eficiencia de Lote:</span>
                                    <strong style="color:#334155;">${((areaPB / area) * 100).toFixed(0)}% Ocupaci√≥n PB</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color:#64748b; font-size:12px;">Altura M√°xima:</span>
                                    <strong style="color:#334155;">${pisos} Pisos</strong>
                                </div>
                            </div>
                            <div style="margin-top: 15px; text-align: center;">
                                <div style="display: inline-block; background: #e0f2fe; color: #0369a1; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;">
                                    TIPO: ${n.uso_principal || 'RESIDENCIAL'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-left: 5px solid #8b5cf6;">
                    <h3 style="color: #5b21b6; font-size: 20px; display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                        üìö Glosario Ciudadano (Diccionario)
                    </h3>

                    <details style="margin-bottom: 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px;">
                        <summary style="font-weight: 600; color: #4c1d95; cursor: pointer;">¬øQu√© es el COS?</summary>
                        <p style="color: #475569; font-size: 14px; margin-top: 5px; padding-left: 15px;">
                            <strong>(Coeficiente de Ocupaci√≥n del Suelo)</strong><br>
                            Es el porcentaje de tu terreno que puede tener techo en la planta baja. Si tienes 100m¬≤ y el COS es 60%, puedes construir 60m¬≤ de casa y debes dejar 40m¬≤ para patio o jard√≠n.
                        </p>
                    </details>

                    <details style="margin-bottom: 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px;">
                        <summary style="font-weight: 600; color: #4c1d95; cursor: pointer;">¬øQu√© es el CUS?</summary>
                        <p style="color: #475569; font-size: 14px; margin-top: 5px; padding-left: 15px;">
                            <strong>(Coeficiente de Utilizaci√≥n del Suelo)</strong><br>
                            Es el volumen total que puedes construir sumando todos los pisos. Imag√≠nalo como la cantidad total de metros cuadrados habitables permitidos en toda la casa.
                        </p>
                    </details>
                    
                    <details style="margin-bottom: 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px;">
                        <summary style="font-weight: 600; color: #4c1d95; cursor: pointer;">¬øQu√© son los Retiros?</summary>
                        <p style="color: #475569; font-size: 14px; margin-top: 5px; padding-left: 15px;">
                            Son las distancias obligatorias que debes dejar sin construir en los bordes de tu terreno (frente, costados y atr√°s) para garantizar ventilaci√≥n, luz y privacidad con tus vecinos.
                        </p>
                    </details>

                    <details style="margin-bottom: 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px;">
                        <summary style="font-weight: 600; color: #4c1d95; cursor: pointer;">¬øQu√© es Lote M√≠nimo y Frente M√≠nimo?</summary>
                        <p style="color: #475569; font-size: 14px; margin-top: 5px; padding-left: 15px;">
                            <strong>Lote M√≠nimo:</strong> Es el tama√±o m√°s peque√±o en el que se puede dividir este terreno si quisieras fraccionarlo.<br>
                            <strong>Frente M√≠nimo:</strong> Es el ancho m√≠nimo que debe tener el terreno hacia la calle.
                        </p>
                    </details>

                    <details style="margin-bottom: 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px;">
                        <summary style="font-weight: 600; color: #4c1d95; cursor: pointer;">¬øQu√© significa √Årea Gr√°fica vs Escritura?</summary>
                        <p style="color: #475569; font-size: 14px; margin-top: 5px; padding-left: 15px;">
                            <strong>√Årea Gr√°fica:</strong> Es lo que mide el terreno seg√∫n el mapa satelital.<br>
                            <strong>√Årea Escritura:</strong> Es lo que dicen tus documentos legales. A veces hay peque√±as diferencias, pero prevalece la escritura.
                        </p>
                    </details>

                    <details>
                        <summary style="font-weight: 600; color: #4c1d95; cursor: pointer;">¬øPuedo construir m√°s pisos de los indicados?</summary>
                        <p style="color: #475569; font-size: 14px; margin-top: 5px; padding-left: 15px;">
                            Por lo general no. La normativa de <strong>${pisos} pisos</strong> est√° dise√±ada para que el barrio crezca ordenadamente y los servicios b√°sicos (agua, luz) alcancen para todos.
                        </p>
                    </details>
                </div>
            `;

            document.getElementById('ciudadanoContent').innerHTML = html;
            document.getElementById('ciudadanoModal').classList.add('active');
        }

        // Estilos para la tabla bonita
        async function generarPlanimetria() {
            try {
                if (!currentData || !currentData.info_predio.geometry) {
                    alert("No hay geometr√≠a seleccionada");
                    return;
                }
                const geojson = currentData.info_predio.geometry;
                const coords = geojson.coordinates[0]; // Array de [long, lat]

                // Procesar coordenadas a UTM y calcular l√≠mites
                let puntosUTM = coords.map(c => {
                    let x = c[0], y = c[1];
                    let isUTM = false;

                    if (typeof proj4 !== 'undefined') {
                        // Verificaci√≥n defensiva extra
                        if (!proj4.defs("EPSG:32717")) {
                            proj4.defs("EPSG:32717", "+proj=utm +zone=17 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs");
                        }
                        try {
                            const utm = proj4("EPSG:4326", "EPSG:32717", c);
                            x = utm[0];
                            y = utm[1];
                            isUTM = true;
                        } catch (e) { console.error(e); }
                    }

                    if (!isUTM) {
                        x = c[0] * 111320;
                        y = c[1] * 110574;
                    }
                    return { lon: c[0], lat: c[1], x: x, y: y };
                });

                // 1. Calcular caja en UTM para el dibujo SVG (proporcional)
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                puntosUTM.forEach(p => {
                    if (p.x < minX) minX = p.x;
                    if (p.x > maxX) maxX = p.x;
                    if (p.y < minY) minY = p.y;
                    if (p.y > maxY) maxY = p.y;
                });

                // Evitar rangos 0
                let rangeX = maxX - minX;
                let rangeY = maxY - minY;
                if (rangeX === 0) rangeX = 1;
                if (rangeY === 0) rangeY = 1;

                // Ajustar M√°rgenes
                const marginX = rangeX * 0.1;
                const marginY = rangeY * 0.1;

                // ViewBox
                const vbW = 800;
                const vbH = 500;

                // Calcular Escala UNIFORME para mantener proporci√≥n
                const scaleX = vbW / (rangeX + 2 * marginX);
                const scaleY = vbH / (rangeY + 2 * marginY);
                const k = Math.min(scaleX, scaleY); // Factor de escala (px/metro)
                const scale = k; // Alias para compatibilidad

                // Calcular dimensiones reales del dibujo en pantalla
                const drawW = rangeX * k;
                const drawH = rangeY * k;

                // Centrar el dibujo en el ViewBox
                const offsetX = (vbW - drawW) / 2;
                const offsetY = (vbH - drawH) / 2;

                // Funciones de mapeo con escala uniforme y centrado
                // mapX: (x - minX) * k + offsetX
                const mapX = (x) => (x - minX) * k + offsetX;
                // mapY: Invertir eje Y. vbH - ((y - minY) * k + offsetY) -> No, mejor: offsetY + (maxY - y) * k
                // SVG Y crece hacia abajo. UTM Y crece hacia arriba.
                // Alineamos maxY con la parte superior (offsetY)
                const mapY = (y) => offsetY + (maxY - y) * k;

                // --- RESTAURAR FETCH DE COLINDANTES ---
                let vecinos = [];
                try {
                    // Intentar buscar por barrio para acotar
                    const barrio = currentData.ubicacion ? currentData.ubicacion.barrio_cod : null;
                    if (barrio) {
                        const { data: vData } = await client
                            .from('predios_urbanos')
                            .select('clave, propietario')
                            .eq('barrio_cod', barrio)
                            .neq('clave', currentData.info_predio.clave)
                            .limit(10);
                        if (vData) vecinos = vData;
                    }
                } catch (err) { console.log("No se pudo cargar vecinos", err); }

                // Fallback si no hay vecinos reales
                if (vecinos.length === 0) {
                    vecinos = [{ clave: "LOTE COLINDANTE", propietario: "DESCONOCIDO" }];
                }
                // -------------------------------------

                // Generar Puntos SVG
                const pointsSvg = puntosUTM.map(p => `${mapX(p.x)},${mapY(p.y)} `).join(" ");

                const area = currentData.info_predio.area_escritura.toFixed(2);
                let tableHtml = "";
                let svgLabels = "";
                let labels = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

                // Estilos para la tabla bonita (Fuente +1pt = 12px, Todo Centrado)
                const tableStyle = `
                width: 100%;
                border-collapse: collapse;
                font-family: 'Inter', sans - serif;
                font-size: 12px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                `;
                const thStyle = `
                background: #1e293b;
                color: white;
                padding: 8px;
                text-align: center;
                font-weight: 600;
                border: 1px solid #0f172a;
                `;
                const tdStyle = `
                padding: 6px 8px;
                border: 1px solid #e2e8f0;
                color: #334155;
                text-align: center;
                `;

                for (let i = 0; i < puntosUTM.length - 1; i++) {
                    const p1 = puntosUTM[i];
                    const p2 = puntosUTM[i + 1];
                    const label = labels[i] || `P${i + 1} `;

                    const sx = mapX(p1.x);
                    const sy = mapY(p1.y);

                    // Distancia Euclidiana en UTM
                    const dist = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));

                    // √Ångulo del segmento para rotar texto
                    const dx = p2.x - p1.x;
                    const dy = p2.y - p1.y;
                    let angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    // Ajustar √°ngulo para lectura (si est√° de cabeza)
                    // En SVG Y invertido -> dy invertido para calculo real, pero aqui p2.y ya es UTM standard. mapY invierte.
                    // Usemos las coordenadas de pantalla para el angulo visual correcto
                    const dsx = mapX(p2.x) - sx;
                    const dsy = mapY(p2.y) - sy;
                    let visualAngle = Math.atan2(dsy, dsx) * 180 / Math.PI;

                    if (visualAngle > 90 || visualAngle < -90) {
                        visualAngle += 180;
                    }

                    // Etiqueta de v√©rtice en el mapa
                    svgLabels += `
                        <circle cx="${sx}" cy="${sy}" r="4" fill="white" stroke="#334155" stroke-width="1.5"/>
                        <circle cx="${sx}" cy="${sy}" r="1" fill="#334155" />
                        <text x="${sx}" y="${sy}" dy="-8" text-anchor="middle" font-family="'Inter', sans-serif" font-size="8" font-weight="700" fill="#334155">${label}</text>
                    `;

                    // Selecci√≥n de Colindante (Heur√≠stica simple: Asignar en orden o aleatorio de la lista real)
                    // Idealmente usar√≠amos intersecci√≥n espacial real.
                    const vecino = vecinos[i % vecinos.length];
                    // Para tabla: Mostrar info completa
                    const colindanciaTabla = vecino.propietario && vecino.propietario !== "DESCONOCIDO"
                        ? vecino.propietario
                        : (vecino.clave ? `${vecino.clave}` : "COLINDANTE");

                    // Para Mapa: NO MOSTRAR NADA (Seg√∫n instrucci√≥n: "no pongas nada ahi")
                    const colindanciaMapa = "";

                    // Etiqueta de distancia en el lado (punto medio, rotada)
                    const midX = (sx + mapX(p2.x)) / 2;
                    const midY = (sy + mapY(p2.y)) / 2;

                    svgLabels += `
                        <g transform="translate(${midX}, ${midY}) rotate(${visualAngle})">
                            <!-- Distancia Arriba -->
                            <text x="0" y="-3" text-anchor="middle" font-family="'Inter', sans-serif" font-size="10" fill="#334155" font-weight="700">${dist.toFixed(2)}m</text>
                            <!-- Colindancia Abajo (VAC√çO) -->
                        </g>
                    `;

                    tableHtml += `
                    <tr style = "${i % 2 === 0 ? 'background: #f8fafc;' : 'background: white;'}" >
                            <td style="${tdStyle}"><b>${label}</b></td>
                            <td style="${tdStyle}">${p1.x.toFixed(3)} E</td>
                            <td style="${tdStyle}">${p1.y.toFixed(3)} N</td>
                            <td style="${tdStyle}">${dist.toFixed(2)} m</td>
                            <td style="${tdStyle}">${colindanciaTabla}</td>
                        </tr>
                    `;
                }

                // Norte Bonito
                const northSvg = `
                    <g transform="translate(${vbW - 50}, 50)">
                         <path d="M 0,-20 L 5,0 L 0,20 L -5,0 Z" fill="white" stroke="#334155" stroke-width="1" />
                         <path d="M 0,-20 L 5,0 L 0,-5 L -5,0 Z" fill="#ef4444" />
                         <text x="0" y="-24" text-anchor="middle" font-family="'Inter', sans-serif" font-weight="800" font-size="12" fill="#1e293b">N</text>
                    </g>
                `;

                // Simbolog√≠a (Leyenda Integrada)
                const legendSvg = `
                    <g transform="translate(10, ${vbH - 85})">
                        <rect width="140" height="75" fill="white" stroke="#cbd5e1" rx="4" fill-opacity="0.95" />
                        <text x="70" y="15" text-anchor="middle" font-family="'Inter', sans-serif" font-size="11" font-weight="700" fill="#334155" style="text-transform:uppercase">SIMBOLOG√çA</text>
                        
                        <g transform="translate(10, 30)">
                            <line x1="0" y1="0" x2="20" y2="0" stroke="#334155" stroke-width="2" />
                            <text x="25" y="3" font-family="'Inter', sans-serif" font-size="10" fill="#475569">L√≠mite de Predio</text>
                        </g>
                        <!-- Grid Eliminado -->
                         <g transform="translate(10, 50)">
                            <circle cx="10" cy="0" r="5" fill="white" stroke="#334155" stroke-width="1" />
                            <circle cx="10" cy="0" r="2" fill="#ef4444" />
                            <text x="25" y="3" font-family="'Inter', sans-serif" font-size="10" fill="#475569">V√©rtice/Hito</text>
                        </g>
                    </g>
                `;


                // Generar Grilla UTM
                let gridSvg = "";

                // Determinar paso de la grilla (ej: 10m, 20m, 50m, 100m)
                const maxRange = Math.max(rangeX, rangeY);
                let step = Math.pow(10, Math.floor(Math.log10(maxRange / 3)));
                if (maxRange / step < 3) step /= 2; // Si hay muy pocas l√≠neas, reducir paso
                if (maxRange / step > 8) step *= 2; // Si hay muchas l√≠neas, aumentar paso

                // L√≠neas Verticales (X constante)
                const startX = Math.ceil(minX / step) * step;
                for (let x = startX; x <= maxX; x += step) {
                    const sx = mapX(x);
                    gridSvg += `
                <line x1 = "${sx}" y1 = "0" x2 = "${sx}" y2 = "${vbH}" stroke = "#cbd5e1" stroke-width="1" stroke-dasharray="4,4" />
                    <text x="${sx}" y="12" text-anchor="middle" font-family="'Inter', sans-serif" font-size="9" fill="#64748b">${Math.round(x)}</text>
            `;
                }

                // L√≠neas Horizontales (Y constante)
                const startY = Math.ceil(minY / step) * step;
                for (let y = startY; y <= maxY; y += step) {
                    const sy = mapY(y);
                    gridSvg += `
                <line x1 = "0" y1 = "${sy}" x2 = "${vbW}" y2 = "${sy}" stroke = "#cbd5e1" stroke-width="1" stroke-dasharray="4,4" />
                    <text x="4" y="${sy - 2}" text-anchor="start" font-family="'Inter', sans-serif" font-size="9" fill="#64748b">${Math.round(y)}</text>
            `;
                }

                const svgContent = `
                <svg width="100%" height="100%" viewBox="0 0 ${vbW} ${vbH}" xmlns="http://www.w3.org/2000/svg" style="background-color: #f8fafc;">
                    
                    ${gridSvg}
                    
                    <polygon points="${pointsSvg}" fill="none" stroke="#94a3b8" stroke-width="4" transform="translate(1,1)" opacity="0.3"/>

                    <polygon points="${pointsSvg}" fill="rgba(16, 185, 129, 0.15)" stroke="#334155" stroke-width="2.5" />
                    
                <text x="${vbW / 2}" y="${vbH / 2}" text-anchor="middle" font-family="'Inter', sans-serif" font-size="16" font-weight="700" fill="black" opacity="0.8">
                    √ÅREA: ${area} m¬≤
                </text>

                    ${svgLabels}
                    ${northSvg}
                    ${legendSvg}
                    
                <text x="${vbW - 10}" y="${vbH - 10}" text-anchor="end" font-family="'Inter', sans-serif" font-size="9" fill="#94a3b8">Grilla UTM WGS84 17S (cada ${step}m)</text>
                </svg>
                `;

                // Calcular Per√≠metro Total
                // Calcular Per√≠metro Total (Validaci√≥n Robusta)
                let perimetro = 0;
                if (puntosUTM && puntosUTM.length >= 3) {
                    // Sumar segmentos intermedios
                    for (let i = 0; i < puntosUTM.length - 1; i++) {
                        const p1 = puntosUTM[i];
                        const p2 = puntosUTM[i + 1];
                        perimetro += Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
                    }

                    // Sumar cierre del pol√≠gono (√∫ltimo -> primero) solo si no son el mismo punto
                    const first = puntosUTM[0];
                    const last = puntosUTM[puntosUTM.length - 1];

                    // Tolerancia para considerar puntos iguales (1mm)
                    const isClosed = Math.abs(first.x - last.x) < 0.001 && Math.abs(first.y - last.y) < 0.001;

                    if (!isClosed) {
                        perimetro += Math.sqrt(Math.pow(first.x - last.x, 2) + Math.pow(first.y - last.y, 2));
                    }
                } else {
                    perimetro = 0; // Datos insuficientes
                }

                // Informaci√≥n General del Predio
                const infoGeneralHtml = `
                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 11px;">
                    <h4 style="margin: 0 0 10px 0; text-transform: uppercase; color: #334155; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px;">Informaci√≥n Catastral y Topogr√°fica</h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                        <div>
                            <span style="display:block; color:#64748b; font-size:10px;">CLAVE CATASTRAL</span>
                            <strong style="color:#0f172a;">${currentData.info_predio.clave}</strong>
                        </div>
                        <div>
                            <span style="display:block; color:#64748b; font-size:10px;">PROPIETARIO</span>
                            <strong style="color:#0f172a;">CONSULTAR EN MUNICIPIO</strong>
                        </div>
                        <div>
                            <span style="display:block; color:#64748b; font-size:10px;">PARROQUIA / ZONA</span>
                            <strong style="color:#0f172a;">${currentData.ubicacion.nombre_parroquia || 'S/D'}</strong>
                        </div>
                        <div>
                            <span style="display:block; color:#64748b; font-size:10px;">USO DE SUELO</span>
                            <strong style="color:#0f172a;">${currentData.normativa.uso_principal || 'RESIDENCIAL'}</strong>
                        </div>
                        
                        <div>
                            <span style="display:block; color:#64748b; font-size:10px;">√ÅREA TOTAL (ESCRITURA)</span>
                            <strong style="color:#0f172a;">${area} m¬≤</strong>
                        </div>
                         <div>
                            <span style="display:block; color:#64748b; font-size:10px;">PER√çMETRO CALCULADO</span>
                            <strong style="color:#0f172a;">${perimetro.toFixed(2)} m</strong>
                        </div>
                        <div>
                            <span style="display:block; color:#64748b; font-size:10px;">FECHA LEVANTAMIENTO</span>
                            <strong style="color:#0f172a;">${new Date().toLocaleDateString()}</strong>
                        </div>
                        <div>
                            <span style="display:block; color:#64748b; font-size:10px;">ESCALA GR√ÅFICA</span>
                            <strong style="color:#0f172a;">1:${Math.round(scale * 100)} (Ref)</strong>
                        </div>
                    </div>
                </div>
            `;

                // Construir tabla
                const tableContainer = `
                <h4 style="margin: 0 0 10px 0; color: #334155; font-size: 13px;">Cuadro de Coordenadas (WGS84 UTM 17S)</h4>
                <table style="${tableStyle} margin-bottom: 20px;">
                    <thead>
                        <tr>
                            <th style="${thStyle} width: 10%;">PUNTO</th>
                            <th style="${thStyle}">ESTE (X)</th>
                            <th style="${thStyle}">NORTE (Y)</th>
                            <th style="${thStyle}">DISTANCIA (m)</th>
                            <th style="${thStyle}">COLINDANTE</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableHtml}
                    </tbody>
                </table>
            `;

                document.getElementById('svgContainer').innerHTML = svgContent;
                document.getElementById('planoArea').innerText = area; // Backup

                const container = document.getElementById('tableContainer');
                if (container) {
                    container.innerHTML = infoGeneralHtml + tableContainer;
                }

                // Simbolog√≠a y Convenciones Detallada
                const linderosHtml = `
                <div style="border:1px solid #cbd5e1; padding:15px; background:#fff; border-radius:8px; display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <h4 style="margin:0 0 10px 0; text-transform:uppercase; color:#334155; font-size:12px;">Simbolog√≠a y Convenciones</h4>
                        <div style="display:grid; grid-template-columns: 1fr; gap:5px; font-size:11px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <div style="width:20px; height:0; border-top:2.5px solid #334155;"></div>
                                <span>Lindero Predio (0.7mm)</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <div style="width:20px; height:0; border-top:1px dashed #cbd5e1;"></div>
                                <span>Grid Coordenadas (0.15mm)</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <div style="width:8px; height:8px; background:#fff; border:1px solid #666; border-radius:50%;"></div>
                                <span>V√©rtice / Hito (Moj√≥n Hormig√≥n)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="flex: 1; border-left: 1px solid #e2e8f0; padding-left: 20px;">
                         <h4 style="margin:0 0 10px 0; text-transform:uppercase; color:#334155; font-size:12px;">Colindancias (Ref)</h4>
                         <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; font-size:11px;">
                             <div><strong>NORTE:</strong> Calle P√∫blica</div>
                             <div><strong>SUR:</strong> Lote N¬∫ 04</div>
                             <div><strong>ESTE:</strong> Lote N¬∫ 02</div>
                             <div><strong>OESTE:</strong> √Årea Verde</div>
                         </div>
                    </div>
                </div>
            `;
                document.getElementById('linderosInfoBox').innerHTML = "";

                document.getElementById('planimetriaModal').classList.add('active');
            } catch (e) {
                console.error(e);
                alert("Error al generar planimetr√≠a: " + e.message);
            }
        }

        function abrirCalculadora() {
            if (!currentData) return;
            const i = currentData.info_predio;
            const n = currentData.normativa || {};
            const u = currentData.ubicacion || {};

            // L√≥gica
            const area = i.area_escritura;
            const cos = n.cos || 60;
            const pisos = n.n_pisos || 3;

            // Estimar dimensiones del lote (CajagetBounding)
            const bounds = predioLayer.getBounds();
            // Distancia aproximada en grados convertida a metros (simplificado)
            const widthDeg = bounds.getEast() - bounds.getWest();
            const heightDeg = bounds.getNorth() - bounds.getSouth();
            const widthM = widthDeg * 111320; // Aprox en ecuador
            const heightM = heightDeg * 110574;
            const anchoLote = Math.min(widthM, heightM).toFixed(1); // Asumimos el lado corto es el frente a veces, pero para retiros usamos logica simple
            const profLote = Math.max(widthM, heightM).toFixed(1);

            // Retiros
            const rFron = parseFloat(n.retiro_fron) || 3;
            const rLat = parseFloat(n.retiro_lat) || 0;
            const rPos = parseFloat(n.retiro_pos) || 3;

            const areaRetiroFron = (rFron * anchoLote);
            const areaRetiroLat = (rLat * profLote);
            const areaRetiroPos = (rPos * anchoLote);
            const areaUtil = (area - areaRetiroFron - areaRetiroLat - areaRetiroPos);
            const areaUtilFinal = Math.max(areaUtil, area * (cos / 100)); // Usamos el COS como safeguard

            const areaPB = (area * (cos / 100));
            const areaTotal = areaPB + (areaUtilFinal * (pisos - 1)); // PB + Pisos superiores

            // Costos
            const costoConstruccion = 650;
            const inversionTotal = areaTotal * costoConstruccion;

            const precioSuelo = (u.nombre_parroquia && u.nombre_parroquia.includes("CENTRO")) ? 450 : 180;

            const html = `
                <div>
                    <div class="calc-section">
                        <div class="calc-header">
                            <span>üìê Esquema de √Åreas</span>
                        </div>
                        <!-- SVG Container para Esquema Visual -->
                        <div id="esquemaRetiros" style="width:100%; height:200px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:15px; display:flex; justify-content:center; align-items:center; position:relative;">
                             <!-- Se llenar√° din√°micamente -->
                        </div>
                         <div style="font-size:11px; text-align:center; color:#64748b; margin-bottom:15px;">
                            <span style="display:inline-block; width:10px; height:10px; background:#ef4444; margin-right:5px; opacity:0.3;"></span>√Årea Retiro (No edificable)
                            <span style="display:inline-block; width:10px; height:10px; background:#22c55e; margin-left:10px; margin-right:5px; opacity:0.3;"></span>√Årea √ötil (Edificable)
                        </div>


                        <div class="calc-header" style="margin-top:0;">
                            <span>C√°lculo Num√©rico</span>
                            <span>${area.toFixed(0)} m¬≤ Lote</span>
                        </div>
                        <div class="calc-row"><span>√Årea Total Terreno:</span> <strong>${area.toFixed(0)} m¬≤</strong></div>
                        <div class="calc-row"><span>Retiros Estimados:</span> <span style="color:#ef4444">-${(area - areaUtilFinal).toFixed(0)} m¬≤</span></div>
                        <div class="calc-row" style="padding-left:10px; font-size:11px; color:#64748b;">‚Ä¢ Frontal (${rFron}m), Lateral (${rLat}m), Posterior (${rPos}m)</div>
                        <div class="calc-total">√ÅREA √öTIL: ${areaUtilFinal.toFixed(2)} m¬≤</div>
                        
                        <div style="margin-top:15px; border-top:1px dashed #e2e8f0; padding-top:10px;">
                            <div class="calc-row"><span>Planta Baja (COS ${cos}%):</span> <strong>${areaPB.toFixed(0)} m¬≤</strong></div>
                            <div class="calc-row"><span>Pisos Superiores (${pisos - 1}):</span> <strong>${(areaUtilFinal * (pisos - 1)).toFixed(0)} m¬≤</strong></div>
                            <div class="calc-total" style="color:#2563eb; font-size:16px;">TOTAL EDIFICABLE: ${areaTotal.toFixed(0)} m¬≤</div>
                        </div>
                    </div>

                    <div class="calc-section">
                        <div class="calc-header">üí∞ Estimaci√≥n Financiera</div>
                        <div class="calc-row"><span>Costo Promedio Const.:</span> <strong>$${costoConstruccion}/m¬≤</strong></div>
                        <div class="calc-total" style="font-size:18px;">INVERSI√ìN OBRA: $${inversionTotal.toLocaleString()}</div>
                        
                        <div style="margin-top:10px; background:#f8fafc; padding:10px; border-radius:8px;">
                            <div class="calc-row">üß± Obra Gris (60%): <span>$${(inversionTotal * 0.6).toLocaleString()}</span></div>
                            <div class="calc-row">üé® Acabados (30%): <span>$${(inversionTotal * 0.3).toLocaleString()}</span></div>
                            <div class="calc-row">üí° Instalaciones (10%): <span>$${(inversionTotal * 0.1).toLocaleString()}</span></div>
                        </div>
                    </div>
                </div>

                
                <div>
                    <div class="calc-section">
                        <div class="calc-header">üìä Mapa de Valores - ${u.nombre_barrio || 'Zona'}</div>
                        <div class="calc-row"><span>Precio Suelo Zona:</span> <strong>$${precioSuelo}/m¬≤</strong></div>
                        <div class="calc-row"><span>Precio Construcci√≥n:</span> <strong>$${costoConstruccion}/m¬≤</strong></div>

                        <table class="market-table" style="margin-top:10px;">
                            <thead><tr><th>Sector</th><th>$/m¬≤</th></tr></thead>
                            <tbody>
                                <tr><td>Centro Hist√≥rico</td><td>$450</td></tr>
                                <tr class="${precioSuelo === 180 ? 'market-highlight' : ''}"><td>El Valle / Norte</td><td>$180 ‚≠ê</td></tr>
                                <tr><td>San Sebasti√°n</td><td>$220</td></tr>
                                <tr><td>Punzara / Sur</td><td>$120</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="calc-section">
                        <div class="calc-header">üè¢ ¬øQu√© puedes construir?</div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                            <div style="text-align:center; padding:10px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px; color:#166534;">
                                üè† Casa ${pisos} Pisos<br><strong>‚úÖ PERMITIDO</strong>
                            </div>
                            <div style="text-align:center; padding:10px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px; color:#166534;">
                                üè≠ Comercio<br><strong>‚úÖ PERMITIDO</strong>
                            </div>
                        </div>
                        <div class="calc-row"><strong>Habitaciones Estimadas:</strong> <span>${Math.floor(areaUtilFinal / 35)} - ${Math.floor(areaUtilFinal / 25)} unid.</span></div>
                        <div style="font-size:11px; color:#64748b;">*Calculado base 25-35m¬≤ por habitaci√≥n master inc. ba√±o</div>
                    </div>
                </div>
            `;

            document.getElementById('calcContent').innerHTML = html;
            document.getElementById('calcModal').classList.add('active');

            // --- L√≥gica de Dibujo SVG (Esquema) ---
            setTimeout(() => {
                const container = document.getElementById('esquemaRetiros');
                if (!container) return;

                const geojson = i.geometry;
                if (!geojson) { container.innerText = "Sin geometr√≠a"; return; }

                // 1. Convertir a coordenadas planas relativas para SVG
                const coords = geojson.coordinates[0];

                // Encontrar bounding box local
                let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                coords.forEach(c => {
                    const x = c[0] * 100000; // Fake projection to keep shape aspect roughly OK locally
                    const y = c[1] * 100000;
                    if (x < minX) minX = x;
                    if (x > maxX) maxX = x;
                    if (y < minY) minY = y;
                    if (y > maxY) maxY = y;
                });

                const width = maxX - minX;
                const height = maxY - minY;
                const maxDim = Math.max(width, height);
                const padding = maxDim * 0.1;

                // Funci√≥n mapeo a SVG (200x200)
                const vbW = 300, vbH = 200;
                const scale = Math.min((vbW - 40) / width, (vbH - 40) / height);

                const mapPt = (lng, lat) => {
                    const x = lng * 100000;
                    const y = lat * 100000;
                    const sx = (x - minX) * scale + 20;
                    const sy = vbH - ((y - minY) * scale + 20); // Y invertida
                    return [sx, sy];
                };

                // Pol√≠gono Original (Lote)
                const ptsOriginal = coords.map(c => mapPt(c[0], c[1]).join(',')).join(' ');

                // 2. Generar Poligono Interior (Retiros) con Turf
                // Usamos un buffer negativo promedio para simplificacion visual
                // 3m es aprox 0.000027 grados.
                const bufferVal = -0.003; // ~3 metros en km aprox 0.003 si unit is km
                let ptsInner = "";
                let hasInner = false;

                try {
                    const poly = turf.polygon(geojson.coordinates);
                    // Retiro promedio visual (ej. 3 metros)
                    const shrunk = turf.buffer(poly, -0.003, { units: 'kilometers' });

                    if (shrunk && shrunk.geometry) {
                        const innerCoords = shrunk.geometry.coordinates;
                        // Manejar Multipolygon si se rompe o simple polygon
                        // Normalmente devuelve Polygon si es simple
                        let rawInner = innerCoords[0];
                        if (shrunk.geometry.type === "MultiPolygon") rawInner = innerCoords[0][0];

                        ptsInner = rawInner.map(c => mapPt(c[0], c[1]).join(',')).join(' ');
                        hasInner = true;
                    }
                } catch (e) { console.log("No se pudo generar buffer visual", e); }

                const svg = `
                <svg width="100%" height="100%" viewBox="0 0 ${vbW} ${vbH}" xmlns="http://www.w3.org/2000/svg">
                    <!-- Fondo (Retiro Area) -->
                    <polygon points="${ptsOriginal}" fill="#fca5a5" stroke="none" fill-opacity="0.5" />
                    
                    <!-- Lote Borde -->
                    <polygon points="${ptsOriginal}" fill="none" stroke="#ef4444" stroke-width="2" stroke-dasharray="4,4" />

                    <!-- Area Util (Verde) -->
                    ${hasInner ? `<polygon points="${ptsInner}" fill="#4ade80" stroke="#16a34a" stroke-width="2" fill-opacity="0.8" />` : ''}
                    
                    ${!hasInner ? `<text x="${vbW / 2}" y="${vbH / 2}" text-anchor="middle" font-size="10" fill="#991b1b">Lote muy estrecho para retiros gr√°ficos</text>` : ''}
                </svg>
                `;

                container.innerHTML = svg;

            }, 200);
        }

        function cerrarPlanimetria() {
            document.getElementById('planimetriaModal').classList.remove('active');
        }

        async function selectRole(role) {
            console.log("Rol seleccionado:", role);

            // 1. Guardar en Base de Datos Supabase
            const { error } = await client
                .from('registro_visitas')
                .insert([{
                    rol: role,
                    user_agent: navigator.userAgent
                }]);

            if (error) console.error("Error guardando visita:", error);

            // 2. Guardar en LocalStorage para no volver a preguntar
            localStorage.setItem('geoLoja_userRole', role);

            // 3. Cerrar Modal
            document.getElementById('roleModal').classList.remove('active');

        }

        function checkUserRole() {
            // Siempre mostrar el modal de selecci√≥n de rol al inicio
            document.getElementById('roleModal').classList.add('active');
        }

        // Funci√≥n para m√≥viles: Colapsar/Expandir panel
        function toggleSidebarMobile() {
            if (window.innerWidth > 768) return; // Solo m√≥vil
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('minimized');

            // Rotar flecha si existe
            const toggle = sb.querySelector('.mobile-toggle');
            if (toggle) {
                toggle.style.transform = sb.classList.contains('minimized') ? 'rotate(180deg)' : 'rotate(0deg)';
            }
        }

        // Auto-expandir al buscar
        const _origMostrar = mostrarResultados;
        mostrarResultados = function (d) {
            _origMostrar(d);
            const sb = document.getElementById('sidebar');
            if (window.innerWidth <= 768) {
                sb.classList.remove('minimized');
                const toggle = sb.querySelector('.mobile-toggle');
                if (toggle) toggle.style.transform = 'rotate(0deg)';
            }
        };



        window.onload = function () {
            initMap();
            checkUserRole();

        };


    </script>
</body>

</html>